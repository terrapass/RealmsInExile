namespace = saruman

# Events about Saruman
#	saruman.0001 - Saruman looks into the palantír.
#				   Options are to pledge alligence to Sauron and convert to Forces of Evil,
#				   or strive against Sauron to wrest control over the Orthanc Stone from him.
#	saruman.0002 - Saruman becomes the Many Coloured.
#	saruman.0003 - Saruman forges a lesser ring of power. Repeatable, as he's got nine spare fingers.
#				   This event will not be in the first release (on hold).
#	saruman.0004 - Gandalf seeks Saruman's council.
#				   The Grey wizard is either imprisoned or Saruman returns to the light.
#	saruman.0005 - "Build me an army worthy of Mordor". Free Uruks.
#	saruman.0006 - Fangorn (unordered)
#	saruman.0007 - Dunlendings (unordered)
#	saruman.0008 - Invasion of Rohan
#	saruman.0009 - 
#	saruman.0010 - 
# Events about Isengard Unleashed/Invasion. This is about the Isengard empire under Saruman.
# Or continued under his court of Uruk-hai, Dunlendings or Half-orcs.
#
#	isengard_unleashed.0001 - 
#	isengard_unleashed.2001 - Letter of invasion
#		scope:isengard_emporer - Saruman



#wotr_setup.0001 = { # This should be the switch for all WotR events per the WotR game rule.
#	type = character_event
#	hidden = yes

#	trigger = {
#		always = no
#	}

#	immediate = {
#		if = {
#			limit = { has_game_rule = default_wotr }
#			trigger_event = { # Saruman looks into the palantír.
#				id = saruman.0001
#				days = { 2 200 }
#			}
#		}
#		else_if = {
#			limit = { has_game_rule = random_wotr }
#			trigger_event = { # Saruman looks into the palantír.
#				id = saruman.0001
#				days = { 200 1200 }
#			}
#			random_list = {
#				50 = {
#				}
#				50 = {
#				}
#			}
#		}
#	}
#}


saruman.0001 = { # Saruman looks into the palantír.
	type = character_event
	title = saruman.0001.t
	desc = saruman.0001.desc
	theme = intrigue
	left_portrait = {
		character = root
		animation = worry
	}

	trigger = {
		is_independent_ruler = yes
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = saruman.0001
				days = { 100 900 }
			}
		}
	}

	immediate = {
		play_music_cue = "mx_cue_murder"
#		trigger_event = {
#			id = saruman.0003 # Ring Maker.
#			days = { 100 600 }
#		}
	}

	option = { # Pledge alligence to Sauron. Convert to the Forces of Evil.
		name = saruman.0001.a
		custom_tooltip = saruman.0001.a.tt

		character:6000053 = {
			set_character_faith = faith:counsel_of_sauron
			capital_county = {
				set_county_faith = faith:counsel_of_sauron
			}
			stress_impact = {
				stubborn = medium_stress_impact_gain
			}
		}
		trigger_event = { # Many Coloured.
			id = saruman.0002
#			days = { 100 300 }
			days = { 2 20 }
		}
		character:maia_sauron = {
			add_opinion = {
				modifier = pleased_opinion
				target = root
				opinion = 40
			}
		}
		ai_chance = {
			base = 100 # LotR: This should be tied to WotR mode.
		}
	}
	option = { # Strive against Sauron to wrest control over the Orthanc Stone from him.
		name = saruman.0001.b
		custom_tooltip = saruman.0001.a.tt

		character:6000053 = {
			add_dread = medium_dread_gain
			stress_impact = {
				stubborn = major_stress_impact_gain
			}
		}
		character:maia_sauron = {
			add_opinion = {
				modifier = hurt_opinion
				target = root
				opinion = -40
			}
		}
		ai_chance = {
			base = 0 # LotR: This should be tied to WotR mode.
		}
	}
}

saruman.0002 = { # Saruman becomes the Many Coloured.
	type = character_event
	title = saruman.0002.t
	desc = saruman.0002.desc
	theme = intrigue
	left_portrait = {
		character = root
		animation = personality_honorable
	}
	
	trigger = {
		is_independent_ruler = yes
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = saruman.0002
				days = { 100 900 }
			}
		}
	}

	immediate = {
		play_music_cue = "mx_cue_positive_effect"
		capital_province = { save_scope_as = capital }
		random_realm_province = {
			limit = { NOT = { this = scope:capital } }
			save_scope_as = province
		}
		character:6000053 = {
			remove_nickname = nick_the_white
			give_nickname = nick_of_many_colors
			add_character_flag = {
				flag = had_nickname_event
			}
		}
#		character:istari_gandalf = {
#			add_opinion = {
#				modifier = hurt_opinion
#				target = root
#				opinion = -40
#			}
#		}
		trigger_event = { # Build me an army.
			id = saruman.0005
			days = { 2 20 }
#			days = { 100 900 }
		}
	}
	option = {
		name = saruman.0002.a
	}
}


saruman.0005 = { # "Build me an army worthy of Mordor." Free Uruk-hai-sies.
	type = character_event
	title = saruman.0005.t
	desc = saruman.0005.desc
	theme = intrigue
	left_portrait = {
		character = root
		animation = personality_brave
	}

	trigger = {
		is_independent_ruler = yes
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = saruman.0002
				days = { 100 900 }
			}
		}
	}

	immediate = {
		form_isengard_unleashed_effect = yes
#		spawn_isengard_uruk_troops_effect = yes
#		character:6000053 = {
#			save_scope_as = story_owner
#			create_story = story_isengard_invasion
#		}
	}

	option = {
		name = saruman.0005.a
	}
}


saruman.0008 = {
	type = empty
	hidden = yes

	immediate = {
		debug_log = "Saruman Invasion of Rohan!"
		debug_log_date = yes
		scope:saruman = {
			save_scope_as = story_owner
			create_story = story_isengard_invasion
		}
	}
}

#saruman.0005 = {
#	hidden = yes
#	immediate = {
#		spawn_isengard_uruk_troops_effect = yes
#	}
#}



isengard_invasion.2001 = {
	type = letter_event
	opening = isengard_invasion.2001.opening
	desc = isengard_invasion.2001.desc
	sender = {
		character = scope:isengard_emperor
		animation = personality_bold
	}

	trigger = {
		NOT = { is_at_war_with = scope:isengard_emperor }
		NOT = { root = scope:isengard_emperor }
	}

	immediate = {
		save_scope_as = demand_recipient
	}

	option = { # Submit
		name = isengard_invasion.2001.a
		custom_tooltip = isengard_invasion.2001.a.tt
		hidden_effect = {
			scope:isengard_emperor = {
				trigger_event = isengard_invasion.2002
			}
		}
		ai_chance = {
			base = 100
			# More likely for Orc group to join the big 'un
			modifier = {
				add = 200
				culture_group = culture_group:orc_group
			}
			# More likely if you're just a count
			modifier = {
				add = 300
				highest_held_title_tier = tier_county
			}
			# More likely if you're a duke
			modifier = {
				add = 100
				highest_held_title_tier = tier_duchy
			}
			# Unlikely if you're Arrogant
			modifier = {
				factor = 0.2
				has_trait = arrogant
			}
			# Unlikely if you're brave
			modifier = {
				factor = 0.2
				has_trait = brave
			}
			# Likely if you're a Craven
			modifier = {
				factor = 1.2
				has_trait = craven
			}
			# Lower chance if you're decently large
			modifier = {
				factor = 0.5
				realm_size >= 35 # Poland-sized
			}
			# No chance of accepting if you're large
			modifier = {
				factor = 0
				realm_size >= 55 # Hungary-sized
			}
			# No chance of accepting if you're a Realm of Free Peoples
			modifier = {
				factor = 0
				has_religion = religion:freepeoples_religion
			}
		}
	}

	option = { # Resist
		name = isengard_invasion.2001.b
		custom_tooltip = isengard_invasion.2001.b.tt
		add_internal_flag = dangerous
		hidden_effect = {
			scope:isengard_emperor = {
				trigger_event = isengard_invasion.2003
			}
		}
		ai_chance = {
			base = 300
		}
	}
}
# Subjugation accepted
isengard_invasion.2002 = {
	type = letter_event
	opening = isengard_invasion.2002.opening
	desc = isengard_invasion.2002.desc
	sender = scope:demand_recipient

	immediate = {
		create_title_and_vassal_change = title_change
		scope:demand_recipient = {
			change_liege = {
				liege = root
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone accepted Isengard subjugation"
		debug_log_scopes = yes
	}

	option = { # Wise choice
		name = isengard_invasion.2002.a
	}
}

# Subjugation refused
isengard_invasion.2003 = {
	type = letter_event
	opening = isengard_invasion.2003.opening
	desc = isengard_invasion.2003.desc
	sender = {
		character = scope:demand_recipient
		animation = personality_bold
	}

	immediate = {
		hidden_effect = {
			scope:demand_recipient.primary_title = {
				save_scope_as = target_title
			}
		}
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone refused Isengard subjugation"
		debug_log_scopes = yes
	}

	option = { # War it is
		name = isengard_invasion.2003.a
		if = {
			limit = {
				exists = scope:target_title.empire
			}
			start_war = {
				cb = isengard_realm_invasion_war
				target = scope:target_title.holder
				target_title = scope:target_title.empire
			}
		}
		else = {
			debug_log = "Failed to find a target empire for a Isengard invasion!"
			debug_log_scopes = yes

			start_war = {
				cb = isengard_realm_invasion_war
				target = scope:target_title.holder
				target_title = scope:target_title.holder.capital_province.empire
			}
		}
	}
}
isengard_invasion.2101 = {
	type = letter_event
	opening = isengard_invasion.2001.opening
	desc = isengard_invasion.2101.desc
	sender = {
		character = scope:isengard_emperor
		animation = personality_bold
	}

	trigger = {
		NOT = { root = scope:isengard_emperor }
	}

	immediate = {
		save_scope_as = demand_recipient
	}

	option = { # Submit
		name = isengard_invasion.2101.a
		custom_tooltip = isengard_invasion.2001.a.tt
		hidden_effect = {
			scope:isengard_emperor = {
				trigger_event = isengard_invasion.2102
			}
		}
		ai_chance = {
			base = 100
			# More likely for Orc group to join the big 'un
			modifier = {
				add = 200
				culture_group = culture_group:orc_group
			}
			# More likely if you're just a count
			modifier = {
				add = 500
				highest_held_title_tier = tier_county
			}
			# More likely if you're a duke
			modifier = {
				add = 200
				highest_held_title_tier = tier_duchy
			}
			# Unlikely if you're Arrogant
			modifier = {
				factor = 0.2
				has_trait = arrogant
			}
			# Unlikely if you're brave
			modifier = {
				factor = 0.2
				has_trait = brave
			}
			# Likely if you're a Craven
			modifier = {
				factor = 2
				has_trait = craven
			}
			# Lower chance if you're decently large
			modifier = {
				factor = 0.5
				realm_size >= 35 # Poland-sized
			}
			# No chance of accepting if you're large
			modifier = {
				factor = 0
				realm_size >= 55 # Hungary-sized
			}
			# No chance of accepting if you're a Realm of Free Peoples
			modifier = {
				factor = 0
				has_religion = religion:freepeoples_religion
			}
		}
	}

	option = {
		name = isengard_invasion.2101.b
		add_internal_flag = dangerous
		custom_tooltip = isengard_invasion.2101.b.tt
		hidden_effect = {
			scope:isengard_emperor = {
				trigger_event = isengard_invasion.2103
			}
		}
		ai_chance = {
			base = 100
		}
	}
}

# Subjugation accepted
isengard_invasion.2102 = {
	type = letter_event
	opening = isengard_invasion.2002.opening
	desc = isengard_invasion.2002.desc
	sender = scope:demand_recipient

	immediate = {
		create_title_and_vassal_change = title_change
		scope:demand_recipient = {
			change_liege = {
				liege = root
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone accepted Isengard subjugation"
		debug_log_scopes = yes
	}

	option = { # Wise choice
		name = isengard_invasion.2002.a
	}
}

# Subjugation refused
isengard_invasion.2103 = {
	type = letter_event
	opening = isengard_invasion.2003.opening
	desc = isengard_invasion.2003.desc
	sender = {
		character = scope:demand_recipient
		animation = personality_bold
	}

	immediate = {
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}
		break_alliance = scope:demand_recipient

		debug_log = "Someone refused Isengard subjugation"
		debug_log_scopes = yes
	}

	# War it is
	option = {
		name = isengard_invasion.2103.a
		start_war = {
			cb = isengard_realm_invasion_war
			target = scope:target_title.holder
			target_title = scope:target_title.empire
		}
		ai_chance = {
			base = 100
		}
	}

	# Just you wait...
	option = {
		name = isengard_invasion.2103.b
		ai_chance = {
			base = 0
		}
	}
}
isengard_invasion.2111 = {
	type = letter_event
	opening = isengard_invasion.2001.opening
	desc = mongol_invasion.2101.desc
	sender = {
		character = scope:isengard_emperor
		animation = personality_bold
	}

	trigger = {
		NOT = { root = scope:isengard_emperor }
	}

	immediate = {
		save_scope_as = demand_recipient
	}

	# Outrageous!
	option = {
		name = isengard_invasion.2111.b
		custom_tooltip = isengard_invasion.2111.b.tt
		hidden_effect = {
			scope:isengard_emperor = {
				trigger_event = isengard_invasion.2112
			}
		}
	}
}

# Subjugation refused
isengard_invasion.2112 = {
	type = letter_event
	opening = isengard_invasion.2003.opening
	desc = isengard_invasion.2112.desc
	sender = scope:demand_recipient

	immediate = {
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone refused Isengard subjugation - Broke alliance"
		debug_log_scopes = yes
	}

	option = { # Our alliance is over
		name = isengard_invasion.2112.a
		break_alliance = scope:demand_recipient
	}
}
