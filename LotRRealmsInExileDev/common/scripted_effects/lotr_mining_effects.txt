### MINING ###

mining_generate_new_random_resource = {
	random_list = {
		## Commons
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_mithril_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_mithril_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_gold_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_gold_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_silver_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_silver_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_lead_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_lead_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_tin_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_tin_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_copper_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_copper_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_iron_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_iron_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_diamond_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_diamond_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_ruby_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_ruby_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_sapphire_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_sapphire_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_emerald_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_emerald_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_amethyst_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_amethyst_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_onyx_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_onyx_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_peridot_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_peridot_province_modifier
				}
			}
		}
		5 = {
			trigger = {
				scope:activity.activity_location = {
					mining_common_quartz_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_quartz_province_modifier
				}
			}
		}

		## Uncommons
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_mithril_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_mithril_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_gold_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_gold_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_silver_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_silver_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_lead_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_lead_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_tin_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_tin_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_copper_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_copper_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_iron_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_iron_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_diamond_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_diamond_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_ruby_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_ruby_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_sapphire_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_sapphire_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_emerald_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_emerald_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_amethyst_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_amethyst_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_onyx_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_onyx_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_peridot_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_peridot_province_modifier
				}
			}
		}
		3 = {
			trigger = {
				scope:activity.activity_location = {
					mining_uncommon_quartz_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_quartz_province_modifier
				}
			}
		}

		## Rares
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_mithril_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_mithril_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_gold_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_gold_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_silver_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_silver_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_lead_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_lead_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_tin_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_tin_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_copper_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_copper_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_iron_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_iron_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_diamond_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_diamond_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_ruby_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_ruby_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_sapphire_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_sapphire_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_emerald_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_emerald_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_amethyst_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_amethyst_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_onyx_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_onyx_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_peridot_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_peridot_province_modifier
				}
			}
		}
		1 = {
			trigger = {
				scope:activity.activity_location = {
					mining_rare_quartz_province = yes
				}
			}
			scope:activity.activity_location = {
				add_province_modifier = {
					modifier = mining_quartz_province_modifier
				}
			}
		}
	}
}

mining_activity_success_change_effect = {
	scope:activity = {
		if = {
			limit = {
				NOT = { exists = var:mining_success_chance_event }
			}
			set_variable = { name = mining_success_chance_event value = 0 }
		}
			change_variable = {
				name = mining_success_chance_event
				add = mining_activity_success_$CHANGE$_value
			}
		set_variable = {
			name = mining_success_chance
			value = mining_success_chance_value
		}
	}
	custom_tooltip = mining_activity_success_$CHANGE$_tt
}

disburse_mining_activity_rewards = {
	# for the loc
	save_scope_as = root_scope
	if = { # To show correct tooltips for guests
		limit = { has_trait = lifestyle_mining }
		add_character_flag = {
			flag = host_existing_miner
			weeks = 1
		}
	}
	mining_individual_guest_awards_effect = yes
	# Rewards based on Magnficence level
	# Host Rewards
	# Prestige/Piety Gain
	if = {
		limit = {
			culture = { has_cultural_parameter = sacred_mining }
		}
		add_prestige = mining_prestige_with_piety_reward_value
		add_piety = mining_piety_reward_value
	}
	else = { add_prestige = mining_prestige_reward_value }
	# Glory Hound Vassal Opinion
	# set_variable = {
	# 	name = attending_glory_hounds
	# 	value = scope:root_scope.number_of_participating_glory_hound_vassals
	# }
	# every_vassal = {
	# 	limit = {
	# 		has_vassal_stance = glory_hound
	# 		is_participant_in_activity = scope:activity
	# 	}
	# 	custom = every_participating_glory_hound_vassal
	# 	add_opinion = {
	# 		modifier = hosted_hunt_opinion
	# 		target = scope:root_scope
	# 		opinion = hunt_glory_hound_vassal_opinion_value
	# 	}
	# }
	# remove_variable = attending_glory_hounds
	scope:activity = {
		hidden_effect = {
			if = {
				limit = {
					activity_host = { has_trait = lifestyle_miner }
				}
				add_to_variable_list = {
					name = trait_rewards
					target = trait:lifestyle_miner
				}
			}
		}
		# People happy when their nobles discover resources that will enrich their area
		if = {
			limit = {
				var:mining_success ?= flag:yes
				has_activity_option = { category = special_option option = mining_type_prospecting }
				activity_location.county.holder.top_liege ?= scope:host.top_liege # own nobles
			}
			activity_location.county = {
				add_county_modifier = {
					modifier = mining_recent_prospecting_success_county_modifier
					years = 10
				}
			}
		}
		show_as_tooltip = {
			every_attending_character = {
				limit = {
					NOR = {
						this = scope:host
						this = root
					}
					is_adult = yes
				}
				custom = mining_every_other_miner_tt
				add_prestige = mining_prestige_guest_gain_value
			}
		}
	}

	# Remove strife if relevant.
	remove_strife_per_invited_powerful_vassal_effect = yes
}

mining_individual_guest_awards_effect = {
	# If character had the reduce stress intent, give them stress loss
	if = { # Hosts
		limit = { this = scope:host }
		if = { # To hide miner tooltip for guests
			limit = { has_character_flag = host_existing_miner }
			if = {
				limit = { scope:activity.var:mining_success ?= flag:yes }
				stress_impact = {
					base = major_stress_loss
					lazy = medium_stress_impact_loss
					gregarious = medium_stress_impact_loss
					lifestyle_miner = major_stress_loss
					shy = medium_stress_impact_gain
				}
			}
			else = {
				stress_impact = {
					base = medium_stress_impact_loss
					lazy = minor_stress_impact_loss
					gregarious = minor_stress_impact_loss
					lifestyle_hunter = medium_stress_impact_loss
					shy = medium_stress_impact_gain
				}
			}
		}
		else = {
			if = {
				limit = { scope:activity.var:mining_success ?= flag:yes }
				stress_impact = {
					base = major_stress_loss
					lazy = medium_stress_impact_loss
					gregarious = medium_stress_impact_loss
					shy = medium_stress_impact_gain
				}
			}
			else = {
				stress_impact = {
					base = medium_stress_impact_loss
					lazy = minor_stress_impact_loss
					gregarious = minor_stress_impact_loss
					shy = medium_stress_impact_gain
				}
			}
		}
	}
	else = { # Guests
		if = {
			limit = { scope:activity.var:mining_success ?= flag:yes }
			stress_impact = {
				base = medium_stress_impact_loss
				lazy = minor_stress_impact_loss
				gregarious = minor_stress_impact_loss
				lifestyle_hunter = medium_stress_impact_loss
				shy = minor_stress_impact_gain
			}
		}
		else = {
			stress_impact = {
				base = minor_stress_impact_loss
				lazy = miniscule_stress_impact_loss
				gregarious = miniscule_stress_impact_loss
				lifestyle_hunter = minor_stress_impact_loss
				shy = minor_stress_impact_gain
			}
		}
	}
	# Prestige/piety
	if = {
		limit = {
			NOT = { this = scope:host }
			is_adult = yes
		}
		if = {
			limit = {
				culture = { has_cultural_parameter = sacred_mining }
			}
			add_prestige = mining_prestige_with_piety_guest_gain_value
			add_piety = mining_piety_guest_gain_value
		}
		else = { add_prestige = mining_prestige_guest_gain_value }
	}
	# Trait XP
	# Only called on the end of a *successful* hunt. Hunts which are interrupted due to death, imprisonment, etc., don't get this, so put critical clean-up stuff in the activity itself.
	if = {
		limit = {
			scope:activity = {
				has_activity_option = { category = special_type option = mining_type_prospecting }
			}
		}
		miner_lifestyle_rank_up_check_effect = { PROSPECTING = yes }
	}
	else = {
		miner_lifestyle_rank_up_check_effect = { PROSPECTING = no }
	}
}

# Give mining xp to every attending character
mining_all_attendee_xp_effect = {
	hidden_effect = {
		scope:activity = {
			every_attending_character = {
				limit = {
					is_alive = yes
				}
				if = {
					limit = { has_trait = lifestyle_miner }
					send_interface_toast = {
						title = miner_xp_gain_message
						miner_progress_point_gain_effect = { CHANGE = $CHANGE$ RANDOM_CHANGE = $RANDOM$ } #Gives points towards ranking up the Hunter Lifestyle
					}
				}
				else = {
					miner_progress_point_gain_effect = { CHANGE = $CHANGE$ RANDOM_CHANGE = $RANDOM$ } #Gives points towards ranking up the Hunter Lifestyle
				}			
			}
		}
	}
}

## Lifestyle Rank Ups
miner_progress_point_gain_effect = {
	if = {
		limit = { is_alive = yes }
		if = {
			limit = {
				NOT = { exists = var:miner_lifestyle_progress }
			}
			set_variable = {
				name = miner_lifestyle_progress
				value = $CHANGE$
			}
		}
		else = {
			change_variable = {
				name = miner_lifestyle_progress
				add = $CHANGE$
			}
		}
		save_scope_value_as = {
			name = mining_base_increase
			value = $CHANGE$
		}
		# Tooltips
		if = {
			limit = { scope:mining_base_increase <= 1 }
			custom_tooltip = mining_progress_towards_trait_1_tt
		}
		else_if = {
			limit = { scope:mining_base_increase = 2 }
			custom_tooltip = mining_progress_towards_trait_2_tt
		}
		else = { custom_tooltip = mining_progress_towards_trait_3_tt }
		#Random chance of additional point to increase unpredictability
		hidden_effect = {
			random = {
				chance = 50
				change_variable = {
					name = miner_lifestyle_progress
					add = $RANDOM_CHANGE$
				}
			}
		}
		#Extra Random chance with the Mining Fervour Tradition
		if = {
			limit = { 
				culture = { has_cultural_parameter = mining_traits_more_common }
			} 
			random = {
				chance = 75
				change_variable = {
					name = miner_lifestyle_progress
					add = 1
				}
			}
		}
	}
}

miner_lifestyle_rank_up_check_effect = {
	save_scope_value_as = {
		name = prospecting
		value = $PROSPECTING$
	}
	if = {
		limit = {
			is_alive = yes
			NOT = { has_trait = lifestyle_miner }
			exists = var:miner_lifestyle_progress
		}
		add_trait = lifestyle_miner
	}
	else_if = { # To show host trait gain for guests
		limit = {
			is_alive = yes
			exists = var:miner_lifestyle_progress
			NOT = { has_character_flag = host_existing_miner }
		}
		add_trait_force_tooltip = lifestyle_miner
	}	
	if = {
		limit = {
			is_alive = yes 
			exists = var:miner_lifestyle_progress
			has_trait = lifestyle_miner
			scope:prospecting = yes
		}
		send_interface_toast = {
			title = miner_xp_gain_message
			if = {
				limit = { var:miner_lifestyle_progress >= miner_rank_up_3_threshold }
				add_trait_xp = {
					trait = lifestyle_miner
					track = prospector
					value = 15
				}
			}
			else_if = {
				limit = { var:miner_lifestyle_progress >= miner_rank_up_2_threshold }
				add_trait_xp = {
					trait = lifestyle_miner
					track = prospector
					value = 10
				}
			}
			else_if = {
				limit = { var:miner_lifestyle_progress >= miner_rank_up_1_threshold }
				add_trait_xp = {
					trait = lifestyle_miner
					track = prospector
					value = 5
				}
			}
			else = {
				add_trait_xp = {
					trait = lifestyle_miner
					track = prospector
					value = 3
				}
			}
		}
	}
	else_if = {
		limit = {
			is_alive = yes
			exists = var:miner_lifestyle_progress
			has_trait = lifestyle_miner
		}
		send_interface_toast = {
			title = miner_xp_gain_message
			if = {
				limit = { var:miner_lifestyle_progress >= miner_rank_up_3_threshold }
				add_trait_xp = {
					trait = lifestyle_miner
					track = hewer
					value = 15
				}
			}
			else_if = {
				limit = { var:miner_lifestyle_progress >= miner_rank_up_2_threshold }
				add_trait_xp = {
					trait = lifestyle_miner
					track = hewer
					value = 10
				}
			}
			else_if = {
				limit = { var:miner_lifestyle_progress >= miner_rank_up_1_threshold }
				add_trait_xp = {
					trait = lifestyle_miner
					track = hewer
					value = 5
				}
			}
			else = {
				add_trait_xp = {
					trait = lifestyle_miner
					track = hewer
					value = 3
				}
			}
		}
	}
	set_variable = {
		name = miner_lifestyle_progress
		value = 0
	}
}