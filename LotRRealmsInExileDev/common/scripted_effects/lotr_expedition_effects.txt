title_change_effect = {
	set_holding_type = dwarven_holding

	create_title_and_vassal_change = {
		type = created
		save_scope_as = change
		add_claim_on_loss = no
	}

	county = {
		set_county_culture = scope:$RULER$.culture
		set_county_faith = scope:$RULER$.faith
			
		change_title_holder = {
			holder = scope:$RULER$
			change = scope:change
		}
	}
	if = {
		limit = { NOT = { scope:$RULER$ ?= scope:host } }
		scope:$RULER$ = { becomes_independent = { change = scope:change } }
	}
	
	resolve_title_and_vassal_change = scope:change
		
	county = { generate_coa = yes }
	county = { scope:$RULER$ = { set_realm_capital = prev } }

	# Give titles away if moving realm
	if = {
		limit = {
			scope:activity = {
				has_activity_option = { category = special_type option = expedition_type_standard }
			}
		}
		scope:host = {
			every_held_title = {
				limit = {
					NOT = { this = scope:activity.activity_location.county }
				}
				add_to_list = transfered_titles
			}
		}
		create_title_and_vassal_change = {
			type = granted
			save_scope_as = change
			add_claim_on_loss = yes
		}

		every_in_list = {
			list = transfered_titles
			change_title_holder = {
				holder = scope:host.var:opportunistic_dwarf
				change = scope:change
			}
		} 
		resolve_title_and_vassal_change = scope:change
	}

	# spawn building at new area
	if = {
		limit = { 
			scope:activity = {
				has_activity_option = { category = expedition_option_gold_investment option = expedition_gold_investment_low }
			}
			add_building = dwarven_fungal_farm_01
		}
	}
	else_if = {
		limit = { 
			scope:activity = {
				has_activity_option = { category = expedition_option_gold_investment option = expedition_gold_investment_medium }
			}
			add_building = dwarven_fungal_farm_02
			add_building = dwarven_forge_01
		}
	}
	else = {
		if = {
			limit = { 
				scope:activity = {
					has_activity_option = { category = expedition_option_gold_investment option = expedition_gold_investment_high }
				}
			}
			add_building = dwarven_fungal_farm_03
			add_building = dwarven_forge_03
			county.title_province = { add_building = dwarven_depths_02 }
		}
	}
}

add_new_councill_members_to_journey = {
	if = {
		limit = { any_knight = { has_variable = $REPLACE_VAR$ } }
		random_knight = {
			limit = { has_variable = $REPLACE_VAR$ }
			root.current_travel_plan ?= { add_companion = prev }
		}
	}
	else_if = {
		limit = { any_courtier = { has_variable = $REPLACE_VAR$ } }
		random_courtier = {
			limit = { has_variable = $REPLACE_VAR$ }
			root.current_travel_plan ?= { add_companion = prev }
		}
	}
	else = {
		if = {
			limit = { cp:$COUNCIL_POS$ = { has_variable = $REPLACE_VAR$ } }
			cp:$COUNCIL_POS$ = { root.current_travel_plan ?= { add_companion = prev } } 
		}
	}
}

assign_new_councillor = {
	assign_councillor_type = { # Marshal
		type = $TYPE$
		remove_existing_councillor = yes
		target = $TARGET$
	}
	$TARGET$ = {
		set_variable = {
			name = block_fire_councillor
			value = root
			years = 5
		}
	}
}