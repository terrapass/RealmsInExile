# LotR: removed references to real world.
#	edited the Scandinavians for adventuring code.

#On actions about titles

# All on-actions in this file provide scope:transfer_type unless otherwise noted
# scope:transfer_type has the following permutations:
# flag:conquest
# flag:conquest_holy_war
# flag:conquest_claim
# flag:conquest_populist
# flag:inheritance
# flag:abdication
# flag:destroyed
# flag:created
# flag:usurped
# flag:granted
# flag:revoked
# flag:election
# flag:independency
# flag:returned
# flag:leased_out
# flag:lease_revoked
# flag:faction_demand
# flag:swear_fealty

# A title is destroyed
# root = the holder before destruction
# scope:landed_title = the title that is being destroyed
# Does *not* provide scope:transfer_type
on_title_destroyed = {
	effect = {
		#LotR - Tracking Imperial Khand Time Held
		if = {
			limit = {
				scope:landed_title = {
					this = title:e_khand
					has_variable = year_khand_founded
				}
			}
			title:e_khand = {
				remove_variable = year_khand_founded
				remove_variable = ruling_dynasty
				remove_variable = successive_rulers
			}
		}
	}
	events = {
	}
}

# A title is transferred to a new character
# root = the new holder
# scope:title = the title that changes hands
# scope:previous_holder = previous holder. Might be dead
on_title_gain = {
	effect = {
		scope:title = { update_dynamic_coa = yes }

		# if = {
		# 	limit = {
		# 		scope:title = {
		# 			tier = tier_empire
		# 			# # scope:previous_holder = { is_alive = no }
		# 		}
		# 		scope:title = title:e_bellakar

		# 		NOT = { title:e_bellakar.holder = { is_allied_to = title:e_gondor.holder } }
		# 		title:e_bellakar.holder = { faith_is_good = yes }
		# 		title:e_gondor.holder = { faith_is_good = yes }
		# 		title:e_bellakar.holder.dynasty = dynasty:dynasty_tumakveh
		# 		title:e_gondor.holder.dynasty = dynasty:dynasty_elros
		# 		AND = {
		# 			OR = {
		# 				is_target_in_global_variable_list = {
		# 					name = unavailable_unique_decisions
		# 					target = flag:gondor_x_bellekar
		# 				}
		# 				is_target_in_global_variable_list = {
		# 					name = unavailable_unique_decisions
		# 					target = flag:bellakar_x_gondor
		# 				}
		# 			}
		# 			is_target_in_global_variable_list = {
		# 				name = unavailable_unique_decisions
		# 				target = flag:recurring_bellakar_gondor_alliance
		# 			}
		# 		}
		# 	}
		# 	title:e_gondor.holder = {
		# 		trigger_event = {
		# 			id = gondor.2951
		# 			days = { 15 30 }
		# 		}
		# 	}
		# }

		#LotR - make sure non-elf feudal vassals of elves get appropriate vassal level law
		if = {
			limit = {
				is_elf = no
				liege = { is_elf = yes }
				government_has_flag = government_is_feudal
			}
			vassal_contract_set_obligation_level = {
				type = feudal_government_levies
				level = feudal_levies_exempt
			}
		}

		if = {
			limit = {
				scope:title = {
					tier = tier_county
					title_province = { has_holding_type = settlement_holding }
					root = { restricted_culture = no }
				}
			}
			send_interface_toast = {
				left_icon = root
				title = settlement_gain_culture_faith_change.toast
				scope:title = {
					set_county_culture = root.culture
					set_county_faith = root.faith
				}
			}
		}

		# Elves are removed when conquered by Orcs or evil-aligned humans
		if = {
			limit = {
				OR = {
					is_orc = yes
					is_undead = yes
					is_maiar_fallen = yes
					is_evil_istari = yes
					faith_is_evil = yes
				}

				scope:title = {
					tier = tier_county
					is_elf = yes
				}
			}
			send_interface_toast = {
				left_icon = root
				title = settlement_conquered_by_orcs.toast

				if = {
					limit = {
						scope:title = {
							has_county_modifier = marauding_orc_drags_modifier
						}
					}
					scope:title = {
						remove_county_modifier = marauding_orc_drags_modifier
					}
				}

				if = {
					limit = { 
						OR = {
							is_undead = yes
							is_maiar_fallen = yes
						}
					}
					scope:title = {
						set_county_culture = culture:kazgumhoth
						set_county_faith = root.faith
						add_county_modifier = {
							modifier = hidden_elven_refugees_modifier
							years = 50
						}
						every_county_province = {
							limit = { 
								NOT = {
									OR = { # If the barony has a settlement or no holding... don't change them
										has_holding_type = settlement_holding 
										province_has_no_holding_trigger = yes
									}
								}
							}
							if = {
								limit = {
									root = { government_has_flag = government_is_tribal }
								}
								set_holding_type = tribal_holding
							}
							else_if = { 
								limit = {
									barony = { is_capital_barony = yes }
								}
								set_holding_type = castle_holding
							}
							else_if = { 
								limit = {
									county = { NOT = { any_county_province = { has_holding_type = city_holding } } }
								}
								set_holding_type = city_holding
							}
							else_if = { 
								limit = {
									county = { NOT = { any_county_province = { has_holding_type = church_holding } } }
								}
								set_holding_type = church_holding
							}
							else = { set_holding_type = castle_holding }
						}
					}
				}
				else_if = {
					limit = { 
						is_evil_istari = yes
					}
					scope:title = {
						set_county_culture = culture:isengard_urukhai
						set_county_faith = root.faith
						add_county_modifier = {
							modifier = hidden_elven_refugees_modifier
							years = 50
						}
						every_county_province = {
							limit = { 
								NOT = {
									OR = { # If the barony has a settlement or no holding... don't change them
										has_holding_type = settlement_holding 
										province_has_no_holding_trigger = yes
									}
								}
							}
							if = {
								limit = {
									root = { government_has_flag = government_is_tribal }
								}
								set_holding_type = tribal_holding
							}
							else_if = { 
								limit = {
									barony = { is_capital_barony = yes }
								}
								set_holding_type = castle_holding
							}
							else_if = { 
								limit = {
									county = { NOT = { any_county_province = { has_holding_type = city_holding } } }
								}
								set_holding_type = city_holding
							}
							else_if = { 
								limit = {
									county = { NOT = { any_county_province = { has_holding_type = church_holding } } }
								}
								set_holding_type = church_holding
							}
							else = { set_holding_type = castle_holding }
						}
					}
				}
				else = {
					scope:title = {
						set_county_culture = root.culture
						set_county_faith = root.faith
						add_county_modifier = {
							modifier = hidden_elven_refugees_modifier
							years = 50
						} 
						every_county_province = {
							limit = { 
								NOT = {
									OR = { # If the barony has a settlement or no holding... don't change them
										has_holding_type = settlement_holding 
										province_has_no_holding_trigger = yes
									}
								}
							}
							if = {
								limit = {
									root = { government_has_flag = government_is_tribal }
								}
								set_holding_type = tribal_holding
							}
							else_if = { 
								limit = {
									barony = { is_capital_barony = yes }
								}
								set_holding_type = castle_holding
							}
							else_if = { 
								limit = {
									county = { NOT = { any_county_province = { has_holding_type = city_holding } } }
								}
								set_holding_type = city_holding
							}
							else_if = { 
								limit = {
									county = { NOT = { any_county_province = { has_holding_type = church_holding } } }
								}
								set_holding_type = church_holding
							}
							else = { set_holding_type = castle_holding }
						}
					}
				}
			}
		}

		# Orcs are removed when conquered by Elves or when reconquering county with hidden elven refugees
		if = {
			limit = {
				is_elf = yes
				
				scope:title = {
					tier = tier_county
					OR = {
						is_orc = yes
						is_undead = yes
						has_county_modifier = hidden_elven_refugees_modifier
					}
				}
			}
			send_interface_toast = {
				left_icon = root
				title = settlement_conquered_by_elves.toast

				if = {
					limit = {
						scope:title = {
							has_county_modifier = hidden_elven_refugees_modifier
						}
					}
					scope:title = {
						remove_county_modifier = hidden_elven_refugees_modifier
					}
				}

				scope:title = {
					set_county_culture = root.culture
					set_county_faith = root.faith
					add_county_modifier = { 
						modifier = marauding_orc_drags_modifier
						years = 25
					}
					title_province = {
						set_holding_type = elven_holding
					}
				}
			}
		}

		# Orcs culture and faith converted when conquered by good aligned-characters
		if = {
			limit = {
				faith_is_good = yes
				
				scope:title = {
					tier = tier_county
					OR = {
						is_orc = yes
						is_undead = yes
						is_maiar_fallen = yes
					}
				}
			}
			send_interface_toast = {
				left_icon = root
				title = settlement_conquered_by_elves.toast

				if = {
					limit = { 
						OR = {
							is_maiar = yes
							is_istari = yes
						}
					}
					scope:title = {
						set_county_culture = culture:gondorian
						set_county_faith = root.faith
						add_county_modifier = { 
							modifier = marauding_orc_drags_modifier
							years = 25
						}
					}
				}
				else = {
					scope:title = {
						set_county_culture = root.culture
						set_county_faith = root.faith
						add_county_modifier = { 
							modifier = marauding_orc_drags_modifier
							years = 25
						}
					}
				}
			}
		}


		if = {
			limit = {
				is_ai = yes
				is_elf = yes
				highest_held_title_tier > tier_county
				scope:title = {
					tier <= tier_county
					title_province = { 
						NOR = { 
							has_holding_type = elven_holding
							has_holding_type = settlement_holding
							has_holding_type = wastelands_holding
						}
					}
				}
			}
			create_character = {
				gender = male
				culture = scope:title.culture
				faith = scope:title.faith
				save_scope_as = new_holder
				location = root.location
			}
			create_title_and_vassal_change = { # Define type of title change as a granting of the title
				type = granted
				save_scope_as = title_change
				add_claim_on_loss = no
			}
			scope:title = {
				change_title_holder = {
					holder = scope:new_holder
					change = scope:title_change
				}
			}
			resolve_title_and_vassal_change = scope:title_change
		}
		else_if = {
			limit = {
				is_ai = yes
				is_elf = no
				highest_held_title_tier > tier_county
				scope:title = {
					tier <= tier_county
					title_province = { has_holding_type = elven_holding }
				}
			}
			create_character = {
				gender = male
				culture = scope:title.culture
				faith = scope:title.faith
				save_scope_as = new_holder
				location = root.location
			}
			create_title_and_vassal_change = { # Define type of title change as a granting of the title
				type = granted
				save_scope_as = title_change
				add_claim_on_loss = no
			}
			scope:title = {
				change_title_holder = {
					holder = scope:new_holder
					change = scope:title_change
				}
			}
			resolve_title_and_vassal_change = scope:title_change
		}

		#LotR - Tracking Imperial Khand Time Held
		if = {
			limit = {
				scope:title = {
					this = title:e_khand
					NOT = { has_variable = year_khand_founded }
				}
			}
			title:e_khand = {
				set_variable = {
					name = year_khand_founded
					value = current_year
				}
				change_variable = {
					name = year_khand_founded
					add = 100
				}
				set_variable = {
					name = ruling_dynasty
					value = root.dynasty
				}
				set_variable = {
					name = successive_rulers
					value = 1
				}
			}
		}
		if = {
			limit = {
				scope:title = {
					this = title:e_khand
				}
			}
			trigger_event = {
				id = khand.0001
				days = 7
			}
		}
		if = {
			limit = {
				scope:title = { is_holy_order = yes }
				NOT = { has_trait = order_member }
				government_has_flag = government_is_holy_order
			}
			add_trait = order_member
		}

		#Did I receive a title from my sibling?
		if = {
			limit = {
				exists = scope:previous_holder
				scope:previous_holder = {
					is_alive = yes
					exists = var:sibling_waiting_for_land
					any_sibling = {
						this = root
						this = scope:previous_holder.var:sibling_waiting_for_land
					}
				}
			}
			add_character_flag = {
				flag = got_title_from_sibling
				years = 4
			}
		}
		
		# Grandeur in elective realms
		if = {
			limit = {
				exists = var:previous_holder_grandeur_value
				has_royal_court = yes
			}
			hidden_effect = {
				change_current_court_grandeur = -100 # Reset to 0
				change_current_court_grandeur = var:previous_holder_grandeur_value
				remove_variable = previous_holder_grandeur_value
			}
		}

		# Petition allowed again
		if = {
			limit = { has_variable = petition_title_cooldown }
			remove_variable = petition_title_cooldown
		}

		# If a player is on their way to pay homage, invalidate.
		if = {
			limit = {
				exists = scope:previous_holder
				any_player = { var:homage_liege_scope ?= scope:previous_holder }
			}
			every_player = {
				limit = {
					var:homage_liege_scope ?= scope:previous_holder
					NOT = { has_character_flag = currently_invalidating_petition_liege_travel }
				}
				current_travel_plan = { cancel_travel_plan = yes }
				trigger_event = pay_homage.0601
				add_character_flag = {
					flag = currently_invalidating_petition_liege_travel
					days = 1
				}
			}
		}

		if = {
			limit = {
				exists = scope:previous_holder
				scope:previous_holder = {
					any_character_artifact = {
						has_variable = artifact_succession_title #Is this an artifact that should follow a title?
						var:artifact_succession_title = { is_title_created = yes } #Does the title the artifact should follow exist?
						var:artifact_succession_title = scope:title #Scope title is the artifact title
					}
				}
			}
			scope:previous_holder = {
				every_character_artifact = {
					limit = {
						has_variable = artifact_succession_title #Is this an artifact that should follow a title?
						var:artifact_succession_title = { is_title_created = yes } #Does the title the artifact should follow exist?
						var:artifact_succession_title = scope:title #Scope title is the artifact title
					}
					if = {
						limit = {
							OR = {
								scope:transfer_type = flag:conquest
								scope:transfer_type = flag:conquest_holy_war
								scope:transfer_type = flag:conquest_claim
								scope:transfer_type = flag:conquest_populist
								scope:transfer_type = flag:abdication
								scope:transfer_type = flag:usurped
								scope:transfer_type = flag:revoked
								scope:transfer_type = flag:faction_demand
							}
						}
						set_owner = {
							target = root
							history = {
								type = conquest
								actor = scope:previous_holder
								recipient = root
								location = scope:previous_holder.location
							}
						}
					}
					else = {
						set_owner = {
							target = root
							history = {
								type = inherited
								recipient = root
							}
						}
					}
				}
			}
		}


		#Struggle Catalyst
		if = {
			limit = {
				# We are only interested in the title within the Struggle Region
				#title:e_spain = {
				#	any_in_de_jure_hierarchy = {
				#		this = 	scope:title
				#	}
				#}
				# Only for usurpation
				scope:transfer_type = flag:usurped

				root = {
					any_character_struggle = {
						involvement = involved
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_usurp_title
							CHAR = root
						}
					}
				}
			}
			root = {
				every_character_struggle = {
					involvement = involved
					limit = {
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_usurp_title
							CHAR = root
						}
					}
					activate_struggle_catalyst = {
						catalyst = catalyst_usurp_title
						character = root
					}
				}
			}
		}

		# Achievements
		# if = { # FP2 El Cid #LotR
		# 	limit = {
		# 		scope:title = title:k_valencia
		# 		has_character_flag = fp2_el_cid_blood_relation_legacy
		# 	}
		# 	set_global_variable = { # DO. NOT. USE. add_achievement_global_variable_effect. IT BREAKS THE ACHIEVEMENT.
		# 		name = fp2_el_cid_achievement_unlocked
		# 		value = yes
		# 	}
		# }
		
		# Am I The Chad?
		# if = { 
		# 	limit = { root = character:easteregg_chad_uhl }
		# 	set_house = house:house_chad_uhl
		# }
		
		# Memories
		# Ascended to the throne
		if = {
			limit = {
				OR = {
					is_ruler = no
					highest_held_title_tier <= scope:title.tier
				}
			}
			
			root = {
				create_character_memory = {
					type = ascended_throne_memory
				}
				
				scope:new_memory = {
					save_scope_as = ascended_throne_memory
					set_variable = {
						name = landed_title
						value = scope:title
					}
				}
			}
		}
		
		if = {
			limit = {
				scope:transfer_type = flag:created
				is_alive = yes
			}
			every_vassal = {
				limit = {
					has_vassal_stance = courtly
				}
				if = {
					limit = {
						scope:title.tier = tier_duchy
					}
					add_opinion = {
						target = root
						modifier = courtly_title_creation_opinion
						opinion = 10
					}
				}
				else = {
					add_opinion = {
						target = root
						modifier = courtly_title_creation_opinion
						opinion = 30
					}
				}
			}
		}
	}
	events = {
		orcs.0010
		# roman_restoration.0005		#New Roman Emperor gets Augustus trait. (old holder, if still alive, loses it)
		# roman_restoration.0199		#Restoring the Pentarchy.
		religious_decision.0312		# Base game: new holder of a county with a runestone
		fp1_other_decisions.0113	# FP1: new holder of a county with a runestone
		delay = { days = 1 }
		realm_maintenance.2001		#Big notification about inheriting emperor tier title
		wraith.001 # Corruption of Minas Ithil
		gondor.2300 # Reclamation of Minas Ithil
		# british_isles.1032			# Danelaw-England partition calc.
		# fp1_major_decisions.1011	# Harald Tanglehair becomes Harald Fairhair.
		# fp1_major_decisions.1012	# If Norway has just been created for the first time, flag that.
		# title_event.0001			# Rename West Francia to France
		# title_event.0002			# Rename East Francia to Germany
		# title_event.0011			# Asturias becomes Leon upon emergence of Castille
	}
}

# A title is inherited by a character
# root = the new holder
# scope:title = the title that changes hands
# scope:previous_holder = previous holder. Should be dead
on_title_gain_inheritance = {
	events = {
		delay = { days = 1 }
		# Try to end inherited entrenched regencies automatically — we need to launder this by a day to make sure the AI realises they've inherited a diarchy.
		diarchy.0113
	}
	effect = {
		
		#LotR - make sure non-elf feudal vassals of elves get appropriate vassal level law
		if = {
			limit = {
				is_elf = no
				liege = { is_elf = yes }
				government_has_flag = government_is_feudal
			}
			vassal_contract_set_obligation_level = {
				type = feudal_government_levies
				level = feudal_levies_exempt
			}
		}
		
		#LotR - make sure elves remain with the elven government type
		if = {
			limit = {
				is_elf = yes
			}
			trigger_event = {
				id = elven_racial.0011
				days = 1
			}
		}

		#If settlement inherited, give back to top liege, unless human.
		if = {
			limit = {
				scope:title = {
					tier = tier_county
					title_province = { has_holding_type = settlement_holding }
				}
				is_independent_ruler = no
				is_ai = yes
			}
			#top_liege = { add_gold = 10000 }
			create_title_and_vassal_change = {
				type = usurped
				save_scope_as = change
				add_claim_on_loss = no
			}
			scope:title = {
				change_title_holder = {
					holder = root.top_liege
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
		}
		if = {
			limit = {
				is_ai = yes
				is_elf = yes
				highest_held_title_tier > tier_county
				scope:title = {
					tier <= tier_county
					title_province = { 
						NOR = { 
							has_holding_type = elven_holding
							has_holding_type = settlement_holding
							has_holding_type = wastelands_holding
						}
					}
				}
			}
			create_character = {
				gender = male
				culture = scope:title.culture
				faith = scope:title.faith
				save_scope_as = new_holder
				location = root.location
			}
			create_title_and_vassal_change = { # Define type of title change as a granting of the title
				type = granted
				save_scope_as = title_change
				add_claim_on_loss = no
			}
			scope:title = {
				change_title_holder = {
					holder = scope:new_holder
					change = scope:title_change
				}
			}
			resolve_title_and_vassal_change = scope:title_change
		}
		else_if = {
			limit = {
				is_ai = yes
				is_elf = no
				highest_held_title_tier > tier_county
				scope:title = {
					tier <= tier_county
					title_province = { has_holding_type = elven_holding }
				}
			}
			create_character = {
				gender = male
				culture = scope:title.culture
				faith = scope:title.faith
				save_scope_as = new_holder
				location = root.location
			}
			create_title_and_vassal_change = { # Define type of title change as a granting of the title
				type = granted
				save_scope_as = title_change
				add_claim_on_loss = no
			}
			scope:title = {
				change_title_holder = {
					holder = scope:new_holder
					change = scope:title_change
				}
			}
			resolve_title_and_vassal_change = scope:title_change
		}
		#LotR - Tracking Imperial Khand Time Held
		if = {
			limit = {
				scope:title = {
					this = title:e_khand
					has_variable = year_khand_founded
					root.dynasty = var:ruling_dynasty
				}
			}
			title:e_khand = {
				change_variable = {
					name = successive_rulers
					add = 1
				}
			}
		}
		else_if = {
			limit = {
				scope:title = {
					this = title:e_khand
					has_variable = year_khand_founded
					NOT = { root.dynasty = var:ruling_dynasty }
				}
			}
			title:e_khand = {
				set_variable = {
					name = ruling_dynasty
					value = root.dynasty
				}
				set_variable = {
					name = successive_rulers
					value = 1
				}
			}
		}
		if = {
			limit = {
				culture = { has_cultural_parameter = realms_shatter_on_succession }
				scope:title = { tier > tier_duchy }
				is_independent_ruler = yes
			}
			every_vassal = {
				limit = {
					opinion = {
						target = root
						value < 0
					}
				}
				create_title_and_vassal_change = {
					type = independency
					save_scope_as = change
					add_claim_on_loss = yes
				}
				becomes_independent = { change = scope:change }
				resolve_title_and_vassal_change = scope:change
			}
		}
		scope:title = {
			if = {
				limit = { 
					root.culture = { has_cultural_parameter = realms_destroyed_on_succession }
					tier >= tier_kingdom
					root = { is_independent_ruler = yes }
					any_de_jure_top_liege = {
						percent < 0.5
						this = root
					}
				}
				root = { destroy_title = scope:title }
			}
		}
	}
}

# A title is usurped by a character
# root = the new holder
# scope:title = the title that changes hands
# scope:previous_holder = previous holder. Shouldn't be dead
on_title_gain_usurpation = {
	events = {
	}
	effect = {
		#LotR - make sure non-elf feudal vassals of elves get appropriate vassal level law
		if = {
			limit = {
				is_elf = no
				liege = { is_elf = yes }
				government_has_flag = government_is_feudal
			}
			vassal_contract_set_obligation_level = {
				type = feudal_government_levies
				level = feudal_levies_exempt
			}
		}
		if = {
			limit = {
				is_ai = yes
				is_elf = yes
				highest_held_title_tier > tier_county
				scope:title = {
					tier <= tier_county
					title_province = { 
						NOR = { 
							has_holding_type = elven_holding
							has_holding_type = settlement_holding
							has_holding_type = wastelands_holding
						}
					}
				}
			}
			create_character = {
				gender = male
				culture = scope:title.culture
				faith = scope:title.faith
				save_scope_as = new_holder
				location = root.location
			}
			create_title_and_vassal_change = { # Define type of title change as a granting of the title
				type = granted
				save_scope_as = title_change
				add_claim_on_loss = no
			}
			scope:title = {
				change_title_holder = {
					holder = scope:new_holder
					change = scope:title_change
				}
			}
			resolve_title_and_vassal_change = scope:title_change
		}
		else_if = {
			limit = {
				is_ai = yes
				is_elf = no
				highest_held_title_tier > tier_county
				scope:title = {
					tier <= tier_county
					title_province = { has_holding_type = elven_holding }
				}
			}
			create_character = {
				gender = male
				culture = scope:title.culture
				faith = scope:title.faith
				save_scope_as = new_holder
				location = root.location
			}
			create_title_and_vassal_change = { # Define type of title change as a granting of the title
				type = granted
				save_scope_as = title_change
				add_claim_on_loss = no
			}
			scope:title = {
				change_title_holder = {
					holder = scope:new_holder
					change = scope:title_change
				}
			}
			resolve_title_and_vassal_change = scope:title_change
		}
	}
}

# A title is lost by a character
# root = the old holder
# scope:title = the title that changes hands
# scope:new_holder = new holder.
on_title_lost = {
	events = {
	}

	effect = {
		#Make sure nobody ever has only the Kingdom of Fashion
		if = {
			limit = {
				scope:title = { tier = tier_kingdom }
				has_title = title:k_fashion
				NOT = {
					any_held_title = { # Only trigger if you don't have any kingdom titles other than Fashion and the kingdom you just lost. Double negative is confusing but it's the only way I could think to script it
						tier = tier_kingdom
						NOT = { this = title:k_fashion }
						NOT = { this = scope:title }
					}
				}
			}
			destroy_title = title:k_fashion
		}
		#Earmark landless Scandinavians for adventuring.
		if = {
			limit = {
				#We only want to grab tribal cultures.
				culture = {
					NOT = { has_cultural_era_or_later = culture_era_late_medieval }
					# NOT = { has_cultural_era_or_later = culture_era_early_medieval }
				}
				#Must have lost their last piece of land.
				is_landed = no
				#If they've ventured far outside Europe, they're unlikely to come back, so we don't #want them.
				scope:title = {
					tier = tier_county
					title_province = {
						OR = {
							geographical_region = middleearth
							# geographical_region = world_europe
							# geographical_region = world_asia_minor
						}
					}
				}
			}
			#Norse, Norwegians, & Danes go into the western adventurer list.
			if = {
				limit = {
					OR = {
						culture = { has_cultural_pillar = heritage_daen }
						culture = { has_cultural_pillar = heritage_dunlending }
						has_culture = culture:eotheod
						has_culture = culture:leofring
						# has_culture = culture:norse
						# has_culture = culture:norwegian
						# has_culture = culture:danish
					}
				}
				add_to_global_variable_list = {
					name = western_scandinavian_adventurer_list
					target = this
				}
			}
			#Norse & Swedes go into the eastern adventurer list.
			if = {
				limit = {
					has_culture = culture:umbarean
					# OR = {
					# 	has_culture = culture:norse
					# 	has_culture = culture:swedish
					# }
				}
				add_to_global_variable_list = {
					name = eastern_scandinavian_adventurer_list
					target = this
				}
			}
		}

		#To remove concubines if a character becomes unlanded
		if = {
			limit = {
				is_landed = no
				any_concubine = { count >= 1 }
			}
			every_concubine = {
				root = {
					remove_concubine = prev
				}
			}
		}

		#Apply loss of stress to the Rivals
		if = {
			limit = {
				scope:title.tier >= tier_county
				OR = {
					scope:transfer_type = flag:conquest
					scope:transfer_type = flag:conquest_holy_war
					scope:transfer_type = flag:conquest_claim
					scope:transfer_type = flag:conquest_populist
					scope:transfer_type = flag:abdication
					scope:transfer_type = flag:usurped
					scope:transfer_type = flag:revoked
					scope:transfer_type = flag:faction_demand
				}
			}
			root = {
				save_scope_as = actor
			}
			every_relation ={
				type = rival

				send_interface_message = {
					type = event_generic_neutral
					title = msg_rival_dethroned
					left_icon = scope:actor
					right_icon = scope:title

					custom_tooltip = msg_rival_dethroned_desc

					stress_impact = { 
						base = medium_stress_loss
						vengeful = medium_stress_loss
					}
				}
			}
		}
		
		# Memories
		# Lost a significant title
		if = {
			limit = {
				scope:title.tier >= highest_held_title_tier
				exists = scope:new_holder
			}
			
			root = {
				create_character_memory = {
					type = lost_title_memory
					
					participants = {
						new_holder = scope:new_holder
					}
				}
				
				scope:new_memory = {
					save_scope_as = lost_title_memory
					set_variable = {
						name = landed_title
						value = scope:title
					}
				}
			}
		}
	}
}

# A claim is gained by a character
# root = the claimant
# scope:title = the title that is claimed
# scope:transfer_type = flag:inheritance or none
on_explicit_claim_gain = {
	effect = {                
        if = { 
            limit = {
				OR = {
					root = {
						has_culture = culture:wastelands
					}
					AND = {
						scope:title = { tier = tier_county }
						scope:title.culture = culture:wastelands
					}
				}                
            }
            debug_log = "Preventing claims from/to Wastelands..."
			every_claim = {
				root = { remove_claim = prev }
			}
		}
	}
	events = {
	}
}

# A claim is lost by a character
# root = the claimant
# scope:title = the title that was claimed
on_explicit_claim_lost = {
	events = {
	}
}

# A title change makes the character rank up in the landed tiers (eg Duke -> King)
# root = character ranking up
# scope:title = old primary title
on_rank_up = { # Will not fire during history execution or for dying characters
	events = {
	}
	effect = {
		add_achievement_flag_effect = { FLAG = achievement_moving_up_in_the_world_flag }
		update_embassies_effect = yes
		every_ally = {
			update_embassies_effect = yes
		}
		# Make a note of ranking up for stele purposes.
		if = {
			limit = {
				# DLC check.
				has_fp1_dlc_trigger = yes
				# Is the culture eligible?
				fp1_can_raise_stele_trigger = yes
				# Aaaaand, for balance reasons, were they landed already?
				exists = scope:title
			}
			set_variable = {
				name = recent_rank_increase
				value = root.primary_title
				years = 5
			}
		}
		# Remove any rank-inappropriate modifiers (e.g., baron buffs).
		remove_character_modifier = mandate_baronial_troops_trained_modifier
		remove_character_modifier = mandate_baronial_troops_half_trained_modifier
		
		# LotR - if protectorate and same title tier as protector, break protectorate
		if = {
			limit = {
				has_variable = overlord_protector
				tier_difference = {
					target = var:my_suzerain
					value >= 0
				}
			}
			send_interface_toast = {
					left_icon = root
					right_icon = var:my_suzerain
					title = rank_up_protectorate.toast
					custom_tooltip = rank_up_protectorate.tt
			}
			var:my_suzerain = {
				send_interface_toast = {
						left_icon = prev
						right_icon = root
						title = rank_up_protector.toast
						custom_tooltip = rank_up_protector.tt
				}
			}
			free_tributary = yes
		}
	}
}

# A title change makes the character rank down in the landed tiers (eg King -> Duke)
# root = character ranking down
# scope:title = old primary title
on_rank_down = { # Will not fire during history execution or for dying characters
	events = {
	}
	effect = {
		if = {
			limit = {
				NOR = {
					has_trait = humble
					has_trait = content
					has_trait = generous
				}
			}
			add_character_flag = {
				flag = make_suicide_available
				years = 5
			}
			set_variable = {
				name = rank_demoted
				value = yes
			}
		}
		update_embassies_effect = yes
		every_ally = {
			update_embassies_effect = yes
		}
		# LotR - if protectorate and same title tier as protector, break protectorate
		every_relation = {
			type = tributary_protectorate
			limit = {
				tier_difference = {
					target = root
					value >= 0
				}
			}
			send_interface_toast = {
				left_icon = root
				right_icon = prev
				title = rank_down_protectorate.toast
				custom_tooltip = rank_down_protectorate.tt
			}
			prev = {
				send_interface_toast = {
						left_icon = root
						title = rank_down_protector.toast
						custom_tooltip = rank_down_protector.tt
				}
			}
			free_tributary_rank_down = yes
		}
	}
}

# A character gains a vassal
# root = character gaining vassal
# scope:vassal = vassal being gained
# scope:old_liege = the previous liege of the vassal. Might be the null character (vassal used to be a non-ruler or independent), so make sure to use "exists" checks where relevant
on_vassal_gained = {
	events = {
		realm_maintenance.1000 # Notify vassals of new liege
	}
	effect = {
		scope:vassal = {
			# LotR - if vassalised character is non-elf and new liege is elf, set feudal contributions to zero
			if = {
				limit = {
					is_elf = no
					root = { is_elf = yes }
					government_has_flag = government_is_feudal
				}
				vassal_contract_set_obligation_level = {
					type = feudal_government_levies
					level = feudal_levies_exempt
				}
			}
			# LotR - if vassalised character is a protector, break protectorates
			every_relation = {
				type = tributary_protectorate
				send_interface_toast = {
					left_icon = scope:vassal
					title = protector_vassalised_protectorate.toast
					custom_tooltip = protector_vassalised_protectorate.tt
				}
				scope:vassal = {
					send_interface_toast = {
							left_icon = scope:vassal
							title = protector_vassalised_protector.toast
							custom_tooltip = protector_vassalised_protector.tt
					}
				}
				free_tributary = yes
			}
			every_in_list = {
				variable = all_tributaries
				free_tributary = yes
				if = {
					limit = {
						has_variable = overlord_protector
					}
					send_interface_toast = {
						left_icon = scope:vassal
						title = protector_vassalised_protectorate.toast
						custom_tooltip = protector_vassalised_protectorate.tt
					}
					scope:vassal = {
						send_interface_toast = {
								left_icon = scope:vassal
								title = protector_vassalised_protector.toast
								custom_tooltip = protector_vassalised_protector.tt
						}
					}
				}
				else_if = {
					limit = {
						has_variable = overlord_suzerain
					}
					send_interface_toast = {
						left_icon = scope:vassal
						title = suzerain_vassalised_tributary.toast
						custom_tooltip = suzerain_vassalised_tributary.tt
					}
					scope:vassal = {
						send_interface_toast = {
								left_icon = scope:vassal
								title = suzerain_vassalised_suzerain.toast
								custom_tooltip = suzerain_vassalised_suzerain.tt
						}
					}
				}
			}
			# LotR - if vassalised character is a protectorate, break protectorate
			if = {
				limit = {
					has_variable = overlord_protector
				}
				send_interface_toast = {
						left_icon = root
						right_icon = var:my_suzerain
						title = protectorate_vassalised_protectorate.toast
						custom_tooltip = protectorate_vassalised_protectorate.tt
				}
				var:my_suzerain = {
					send_interface_toast = {
							left_icon = prev
							right_icon = root
							title = protectorate_vassalised_protector.toast
							custom_tooltip = protectorate_vassalised_protector.tt
					}
				}
				free_tributary = yes
			}
			else_if = {
				limit = {
					has_variable = overlord_suzerain
				}
				send_interface_toast = {
						left_icon = root
						right_icon = var:my_suzerain
						title = tributary_vassalised_tributary.toast
						custom_tooltip = tributary_vassalised_tributary.tt
				}
				var:my_suzerain = {
					send_interface_toast = {
							left_icon = prev
							right_icon = root
							title = tributary_vassalised_suzerain.toast
							custom_tooltip = tributary_vassalised_suzerain.tt
					}
				}
				free_tributary = yes
			}
		}
		# Struggle Catalyst
		if = {
			limit = {
				# Verify if vassal used to be independent
				NOT = { exists = scope:old_liege }
				root = {
					any_character_struggle = {
						involvement = involved
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_vassalize_independent_ruler
							CHAR = scope:vassal
						}
					}
				}
			}
			root = {
				every_character_struggle = {
					involvement = involved
					limit = {
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_vassalize_independent_ruler
							CHAR = scope:vassal
						}
					}
					activate_struggle_catalyst = {
						catalyst = catalyst_vassalize_independent_ruler
						character = root
					}
				}
			}
		}
	}
	events = {
		realm_maintenance.1000 # Notify vassals of new liege
	}
}

# A baron is found or created for a title, E.G., due to the player using the "Give to Low Noble" action
# No transfer type here; it's always a grant
# root = the baron
# scope:liege = the person who wanted them created
# scope:title = the barony
on_baron_found_or_created_for_title = {
	effect = {
		add_opinion = {
			target = scope:liege
			modifier = received_title_barony
		}
	}
	
	events = {
		race.0001 #set up races
	}
}
