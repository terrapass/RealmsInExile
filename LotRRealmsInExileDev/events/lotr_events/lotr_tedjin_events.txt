namespace = tedjin

# Tedjin.0100 = Tedjin start-up events (Character intros)

tedjin.0100 = { # Introduction to Ayal, Kataj of the Confederacy
	title = tedjin.0100.t
	desc = tedjin.0100.desc
	theme = stewardship_duty_focus
	
	trigger = {
		character:lineofthezij42 = root
	}
	
	left_portrait = {
		character = root
		animation = worry
	}
	right_portrait = {
		character = character:lineofazumenakhad79
		animation = worry
	}
	
	option = { # All my work for naught...
		name = tedjin.0100.a
	}
}

#Tedjin Faction Demand Events

tedjin.0001 = { # Faction Demand Notice
	type = letter_event
	sender = scope:faction_leader
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_SEND_DEMAND_NOTIFICATION"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_SEND_DEMAND_NOTIFICATION_DESC"

	option = {
		name = "FACTION_DEMAND_SEND_DEMAND_NOTIFICATION_OPT"	
	}
}

tedjin.0002 = {
	type = letter_event
	sender = scope:faction_leader
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_DESC"
	
	trigger = {
		exists = scope:faction # May have ceased to exist by the time this triggers
	}

	option = {
		name = "FACTION_DEMAND_ACCEPT"

		scope:faction = {
			every_faction_member = {
				trigger_event = tedjin.0003
			}
		}

		create_title_and_vassal_change = {
			type = faction_demand
			save_scope_as = change
			add_claim_on_loss = no
		}

		root = {
			save_scope_as = faction_target
			add_prestige = -500			
			add_dread = -30
			every_held_title = {
				change_title_holder = {
					holder = scope:faction_leader
					change = scope:change
				}
			}
		}
		
		resolve_title_and_vassal_change = scope:change

		ai_chance = {
			base = 1
			modifier = {
				add = 99
				scope:faction = { faction_power >= 100 }
			}
			modifier = {
				add = 50
				scope:faction = { faction_power >= 125 }
			}
			modifier = {
				add = 50
				scope:faction = { faction_power >= 150 }
			}
			modifier = {
				add = 50
				scope:faction = { faction_power >= 200 }
			}
			modifier = {
				factor = 0.1
				any_ally = {
					NOR = {
						target_is_liege_or_above = root
						target_is_vassal_or_below = root
					}
					max_military_strength > root.max_military_strength
				}
			}
			compare_modifier = {
				value = debt_level
				multiplier = 25
			}
			modifier = {
				add = -50
				scope:faction_target = {
					is_at_war = no
					primary_title.tier >= tier_kingdom
				}
			}
			modifier = {
				add = -150
				scope:faction_target = {
					is_at_war = no
					primary_title.tier >= tier_empire
				}
			}
		}
	}

	option = {
		name = "FACTION_DEMAND_REFUSE"

		show_as_tooltip = {
			scope:faction = {
				faction_start_war = {}
			}
		}
		
		root = {
			save_scope_as = faction_target
		}
		
		scope:faction_leader = {
			trigger_event = tedjin.0004
		}

		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_boldness = 4.0
			}
			modifier = {
				add = 50
				scope:faction = { faction_power < 80 }
			}
			modifier = {
				add = 100
				scope:faction = { faction_power < 60 }
			}
			modifier = {
				add = 1000
				scope:faction = { faction_power < 40 }
			}
			compare_modifier = {
				value = debt_level
				multiplier = -25
			}
		}
	}
}

tedjin.0003 = { #Acceptance notification
	type = letter_event
	sender = scope:faction_target
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_ACCEPTED"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_ACCEPTED_DESC"

	option = {
		name = "FACTION_DEMAND_ACCEPTED_OPT"
#		custom_tooltip = faction_demand.0002.tt
	}
}

tedjin.0004 = { #Refusal notification to leader
	type = letter_event
	sender = scope:faction_target
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_REFUSED"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_REFUSED_DESC"

	option = {
		name = "FACTION_DEMAND_REFUSED_OPT"
		scope:faction = {
			faction_start_war = {}
			
			every_faction_member = {
				limit = { NOT = { this = scope:faction.faction_leader } }
				trigger_event = tedjin.0005
			}
		}
	}
}

tedjin.0005 = { #Refusal notification to members
	type = letter_event
	sender = scope:faction_target
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_REFUSED"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_REFUSED_DESC"

	option = {
		name = "FACTION_DEMAND_REFUSED_OPT"	
	}
}

# Tedjin Events

tedjin.0101 = { # HIDDEN - handling of the death of Ayal - check who is is successor
	hidden = yes

	trigger = {
		character:lineofthezij42 = root
	}
	
	immediate = {
		if = { # Bor - full reforms and civil war path
			limit = {
				root.primary_heir = character:lineofthezij51
			}
			root.primary_heir = {
				trigger_event = {
					id = tedjin.0102
					days = 1
				}
			}
		}
		
		else_if = { # Borlach - civil war likely averted 
			name = tedjin.0101.b
			limit = {
				root.primary_heir = character:lineofthezij52
			}
			root.primary_heir = {
				trigger_event = {
					id = tedjin.0103
					days = 1
				}
			}
		}
	
		else_if = { # Heathen young child of Bor or Borlach - title disolution
			name = tedjin.0101.c
			limit = {	
				NOT = { root.primary_heir = character:lineofthezij52 }
				NOT = { root.primary_heir = character:lineofthezij50 }
				OR = {
					AND = {
						root.primary_heir.father = root
						NOT = { root.primary_heir.faith = faith:faith_easterling_war }
					}
					AND = {
						root.primary_heir.father = character:lineofthezij51
						NOT = { root.primary_heir.faith = faith:faith_easterling_war }
					}
					AND = {
						root.primary_heir.father = character:lineofthezij52
						NOT = { root.primary_heir.faith = faith:faith_easterling_war }
					}
				}
			}
			root.primary_heir = {
				trigger_event = {
					id = tedjin.0106
					days = 1
				}
			}
		}
		
		else_if = { # Tarika - last of the house of Thezij - diffused
			name = tedjin.0101.d
			limit = {
				root.primary_heir = character:lineofthezij50
			}
			root.primary_heir = {
				trigger_event = {
					id = tedjin.0107
					days = 1
				}
			}
		}
		
		else = { # Anyone else - diffused
			name = tedjin.0101.e
			root.primary_heir = {
				trigger_event = {
					id = tedjin.0108
					days = 1
				}
			}
		}
	}
}

tedjin.0102 = { # Death of Ayal - Bor rules the Confederacy - things could get ugly
	title = tedjin.0102.t
	desc = tedjin.0102.desc
	theme = death
	left_portrait = {
		character = root
		animation = personality_honorable
	}
	right_portrait = {
		character = character:lineofthezij42
		animation = pain
	}
	
	option = { # Things are about to get messy...
		name = tedjin.0102.a
		if = { #If Gyuruchill II is still alive, cue countdown of death
			limit = {
				character:lineofazumenakhad79 = {
					is_alive = yes
				}
			}
			trigger_event = {
				id = tedjin.0110
				days = { 30 300 }
			}			
		}
		else = { #If Gyuruchill II is dead, then cue Bulga's appeal
			trigger_event = {
				id = tedjin.0111
				days = { 30 90 }
			}
		}
	}
}

tedjin.0103 = { # Death of Ayal - Borlach rules the Confederacy - how should I rule?
	title = tedjin.0103.t
	desc = tedjin.0103.desc
	theme = death
	left_portrait = {
		character = root
		animation = worry
	}
	right_portrait = {
		character = character:lineofthezij42
		animation = pain
	}	
	
	option = { # Moderate - A conventional ruler, trying to find the balance
		name = tedjin.0103.a
		stress_impact = {
			stubborn = medium_stress_impact_gain
		}
		if = {
			limit = { has_realm_law = crown_authority_1 }
			add_realm_law = crown_authority_0
		}
		else_if = {
			limit = { has_realm_law = crown_authority_2 }
			add_realm_law = crown_authority_1
		}
		else_if = {
			limit = { has_realm_law = crown_authority_3 }
			add_realm_law = crown_authority_2
		} 
		add_character_modifier = {
			modifier = tedjin_moderate_modifier
		}
	}
	
	option = { # Conservative - Reconvert and give vassals their traditional freedoms
		name = tedjin.0103.b
		stress_impact = {
			stubborn = medium_stress_impact_gain
			zealous = major_stress_impact_gain
		}
		set_character_faith = faith:faith_easterling_war
		add_piety_level = -1
		add_character_modifier = {
			modifier = reconverted_tedjin_modifier
			years = 25
		}
		every_vassal = {
			limit = {
				AND = {
					has_government = feudal_government
					has_faith = faith:faith_easterling_war
				}
			}
			vassal_contract_set_obligation_level = {
				type = war_declaration_rights
				level = war_declaration_rights_allowed
			}
		}
		every_vassal = {
			limit = {
				dynasty = dynasty:dynasty_azumenakhad
			}
			vassal_contract_set_obligation_level = {
				type = council_rights
				level = council_rights_guaranteed
			}			
		}
		every_vassal = {
			limit = {
				NOT = { faith = faith:faith_easterling_war } 
			}
			add_character_modifier = {
				modifier = reconverted_tedjin_liege_modifier
			}			
		}
	}
	
	option = { # Secession - Split the realm along faith lines
		name = tedjin.0103.c
		
		stress_impact = {
			stubborn = major_stress_impact_gain
		}
		
		create_title_and_vassal_change = {
			type = faction_demand
			save_scope_as = change
			add_claim_on_loss = no
		}
		
		title:k_tedjin = {
			change_title_holder = {
				holder = dynasty:dynasty_azumenakhad.dynast
				change = scope:change
			}
		}

		every_vassal = {
			limit = {
				has_faith = faith:faith_easterling_war
			}
			
			change_liege = {
				liege = dynasty:dynasty_azumenakhad.dynast
				change = scope:change
			}		
		}
			
		resolve_title_and_vassal_change = scope:change

		get_title = k_soriya

		set_culture = culture:soriyan
		
		every_child = {
			set_culture = culture:soriyan
		}

		dynasty:dynasty_azumenakhad.dynast = { #Notify new ruler of the Tedjin Confederacy, transfer faithful vassals to Soriya
			trigger_event = tedjin.0104
		}
		
	}
}

tedjin.0104 = { # Secession resolution
	hidden = yes
	
	immediate = { # transfer faithful vassals to Soriya
		create_title_and_vassal_change = {
			type = faction_demand
			save_scope_as = change
			add_claim_on_loss = no
		}
		every_vassal = {
			limit = {
				has_faith = faith:faith_path_of_wisdom
			}
			
			change_liege = {
				liege = title:k_soriya.holder
				change = scope:change
			}			
		}
		resolve_title_and_vassal_change = scope:change		
		title:k_soriya.holder = {
			trigger_event = tedjin.0105
		}
		title:k_tedjin.holder = {
			trigger_event = tedjin.0105
		}
	}
}

tedjin.0105 = { # Secession sign off event - a new dawn for Soriya and the confederacy (shared event)
	title = tedjin.0105.t
	desc = tedjin.0105.desc
	theme = rival_relation
	override_background = { event_background = temple_mosque }
	left_portrait = {
		character = title:k_soriya.holder
		animation = war_defender
	}
	right_portrait = {
		character = title:k_tedjin.holder
		animation = war_attacker
	}
	
	option = { # Soriya rises
		name = tedjin.0105.a
		trigger = { has_title = title:k_soriya } 
	}
	option = { # A new dawn for the Confederacy
		name = tedjin.0105.b
		trigger = { has_title = title:k_tedjin } 
	}
}

tedjin.0106 = { # Death of Ayal - Heathen child rules the Confederacy - the Confederacy dissolves
	title = tedjin.0106.t
	desc = tedjin.0106.desc
	theme = death
	left_portrait = {
		character = root
		animation = angry
	}
	
	option = { # Yeh, so! Do I get a toy yet?
		name = tedjin.0106.a
		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = no
		}
		every_vassal = {
			limit = {
				NOR = { 
					has_title = title:c_abrazayan
					has_title = title:c_agathmardru
					has_title = title:c_kaneja
					has_title = title:c_zimrenzil
					has_title = title:d_kes_ebb
				}
			}			
			becomes_independent = {
				change = scope:change
			}			
		}
		every_vassal = {
			limit = {
				has_title = title:d_kes_ebb
			}			
			change_liege = {
				liege = title:k_felaya.holder
				change = scope:change
			}			
		}
		resolve_title_and_vassal_change = scope:change
		destroy_title = title:k_tedjin
	}
}

tedjin.0107 = { # Death of Ayal - Tarika rules the Confederacy - Last of the Thezij?
	title = tedjin.0107.t
	desc = tedjin.0107.desc
	theme = death
	left_portrait = {
		character = root
		animation = angry
	}
	
	option = { # My line has ended!
		name = tedjin.0107.a
		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = no
		}
		every_vassal = {
			limit = {
				has_title = title:d_kes_ebb
			}			
			change_liege = {
				liege = title:k_felaya.holder
				change = scope:change
			}			
		}
		resolve_title_and_vassal_change = scope:change
	}
}

tedjin.0108 = { # Death of Ayal - Someone else rules the Confederacy - an uncertain future
	title = tedjin.0108.t
	desc = tedjin.0108.desc
	theme = death
	left_portrait = {
		character = root
		animation = angry
	}
	
	option = { # An uncertain future
		name = tedjin.0108.a
		create_title_and_vassal_change = {
			type = independency
			save_scope_as = change
			add_claim_on_loss = no
		}
		every_vassal = {
			limit = {
				has_title = title:d_kes_ebb
			}			
			change_liege = {
				liege = title:k_felaya.holder
				change = scope:change
			}			
		}
		resolve_title_and_vassal_change = scope:change
	}
}

tedjin.0110 = { # Death of Gyuruchill II
	hidden = yes
	
	immediate = { # Kill Gyuruchill II
		if = { #If Gyuruchill II is still alive after countdown, kill
			limit = {
				character:lineofazumenakhad79 = {
					is_alive = yes
				}
			}
			character:lineofazumenakhad79 = {
				death = natural
			}			
		}
		character:lineofthezij51 = {		
			trigger_event = { #Cue Bulga's appeal
				id = tedjin.0111
				days = 30
			}
		}
	}
}

tedjin.0111 = { # Bor's perspective - send out for Bulga's appeal
	title = tedjin.0111.t
	desc = tedjin.0111.desc
	theme = diplomacy
	left_portrait = {
		character = root
		animation = personality_cynical
	}
	right_portrait = {
		character = character:lineofazumenakhad87
		animation = beg
	}
	
	option = { # Kill Gyuruchill II
		name = tedjin.0111.a
		character:lineofazumenakhad81 = {
			trigger_event = { # Bulga goes on her way
				id = tedjin.0112
				days = { 30 60 }
			}
		}
	}
}

tedjin.0112 = { # Bulga's appeal
	title = tedjin.0112.t
	desc = tedjin.0112.desc
	theme = death
	left_portrait = {
		character = root
		animation = stress
	}
	right_portrait = {
		character = character:lineofazumenakhad87
		animation = beg
	}
	
	option = { # Ignore her pleas
		name = tedjin.0112.a
		add_piety = 150
		#add_character_modifier = { 
		#	modifier = #Potentially make it harder to kill him with schemes
		#}
		##CUE FOREIGN SUPPORT
		#character:lineofthezij51 = {		
		#	trigger_event = { #Bulga returns disappointed
		#		id = tedjin.0103
		#		days = 1
		#	}
		#}
		create_faction = {
			type = tedjin_civil_war_faction  #tedjin_civil_war_faction
			target = character:lineofthezij51
		}
	}
	
	option = { # Relent and convert
		name = tedjin.0112.b
		stress_impact = {
			zealous = major_stress_impact_gain
		}
		set_character_faith_with_conversion = faith:faith_path_of_wisdom
		add_piety_level = -1
		add_character_modifier = {
			modifier = reconverted_tedjin_modifier
			years = 25
		}
		remove_trait = zealous
		add_trait_force_tooltip = fickle
		if = {
			limit = {
				character:lineofthezij51 = { is_alive = yes }
			}
			remove_relation_rival = character:lineofthezij51
			set_relation_friend = character:lineofthezij51
		}
		##TRIGGER NOTIFICATION OF WAR
	}
}

tedjin.0113 = { # Bor decides how he should reign
	title = tedjin.0113.t
	desc = tedjin.0113.desc
	theme = death
	left_portrait = {
		character = root
		animation = angry
	}
	
	option = { # Reformist - A campaign of rigourous centralisation, conversion and modernisation
		name = tedjin.0113.a
		if = {
			limit = { has_realm_law = crown_authority_2 }
			add_realm_law = crown_authority_3
		}
		else_if = {
			limit = { has_realm_law = crown_authority_1 }
			add_realm_law = crown_authority_2
		}
		else_if = {
			limit = { has_realm_law = crown_authority_0 }
			add_realm_law = crown_authority_1
		} 
		add_character_modifier = {
			modifier = tedjin_reformer_modifier
		}
	}
	
	option = { # Moderate - A conventional ruler, trying to find the balance
		name = tedjin.0113.b
		stress_impact = {
			stubborn = medium_stress_impact_gain
		}
		if = {
			limit = { has_realm_law = crown_authority_1 }
			add_realm_law = crown_authority_0
		}
		else_if = {
			limit = { has_realm_law = crown_authority_2 }
			add_realm_law = crown_authority_1
		}
		else_if = {
			limit = { has_realm_law = crown_authority_3 }
			add_realm_law = crown_authority_2
		} 
		add_character_modifier = {
			modifier = tedjin_moderate_modifier
		}
	}
	
	option = { # Conservative - Reconvert and give vassals their traditional freedoms
		name = tedjin.0113.c
		stress_impact = {
			stubborn = medium_stress_impact_gain
			zealous = major_stress_impact_gain
		}
		remove_trait = zealous
		add_trait_force_tooltip = fickle
		set_character_faith = faith:faith_easterling_war
		add_piety_level = -1
		add_character_modifier = {
			modifier = reconverted_tedjin_modifier
			years = 25
		}
		if = {
			limit = {
				character:lineofazumenakhad81 = { is_alive = yes }
			}
			remove_relation_rival = character:lineofazumenakhad81
			set_relation_friend = character:lineofazumenakhad81
		}
		every_vassal = {
			limit = {
				OR = {
					has_government = feudal_government
				}
			}
			vassal_contract_set_obligation_level = {
				type = war_declaration_rights
				level = war_declaration_rights_allowed
			}
		}
		every_vassal = {
			limit = {
				dynasty = dynasty:dynasty_azumenakhad
			}
			vassal_contract_set_obligation_level = {
				type = council_rights
				level = council_rights_guaranteed
			}			
		}
		every_vassal = {
			limit = {
				NOT = { faith = faith:faith_easterling_war } 
			}
			add_character_modifier = {
				modifier = reconverted_tedjin_liege_modifier
			}			
		}
	}
	
	option = { # Secession - Split the realm along faith lines
		name = tedjin.0113.d
		
		stress_impact = {
			stubborn = major_stress_impact_gain
		}
		
		if = {
			limit = {
				character:lineofazumenakhad81 = { is_alive = yes }
			}
			remove_relation_rival = character:lineofazumenakhad81
		}
		
		create_title_and_vassal_change = {
			type = faction_demand
			save_scope_as = change
			add_claim_on_loss = no
		}
		
		title:k_tedjin = {
			change_title_holder = {
				holder = character:lineofazumenakhad81
				change = scope:change
			}
		}

		every_vassal = {
			limit = {
				has_faith = faith:faith_easterling_war
			}
			
			change_liege = {
				liege = character:lineofazumenakhad81
				change = scope:change
			}		
		}
			
		resolve_title_and_vassal_change = scope:change

		get_title = k_soriya

		set_culture = culture:soriyan
		
		every_child = {
			set_culture = culture:soriyan
		}

		character:lineofazumenakhad81 = { #Notify and resolve for Azumen, transfer faithful vassals to Soriya
			trigger_event = tedjin.0107
		}
		
	}
}


tedjin.0200 = { # The Civil War begins
	title = tedjin.0200.t
	desc = tedjin.0200.desc
	theme = vassal
	left_portrait = {
		character = root
		animation = stress
	}
	
	option = { 
		name = tedjin.0200.a # Cave to their demands
		#every_vassal = { # Notify the lords!
		#	trigger_event = {
		#		#id = gondor.0556
		#	}		
		#}
		#character:lineisildur42 = { # Aragorn is allowed into Minas Tirith
		#	trigger_event = {
		#		id = gondor.0502
		#		days = { 30 60 }
		#	}
		#}
		#ai_chance = {
		#	base = 20 # LotR: The AI has already made its choice - this is a last check for the player, but give a small chance for variety
		#}
	}
	
	option = { 
		name = tedjin.0200.b # I shall not be blackmailed... to war!
		# Start war
		#title:k_belfalas.holder = { # Notify the Rebel Leader
		#	start_war = { 
		#		casus_belli = kingstrife_cb
		#		target = root
		#	}
		#	trigger_event = {
		#		id = gondor.0557
		#	}
		#}
		#every_vassal = { # Let all other lords pick their side
		#	limit = {
		#		NOT = { has_title = title:k_belfalas }
		#	}
		#	trigger_event = {
		#		id = gondor.0558
		#		days = 1
		#	}		
		#}
		#title:e_mordor.holder = { # Notify Sauron after some time
		#	trigger_event = {
		#		id = gondor.0559
		#		days = { 30 180 }
		#	}
		#}
		#every_living_character = {
		#	limit = {
		#		NOT = { root = this }
		#	}
		#	trigger_event = { 
		#		id = gondor.0560
		#		days = 14
		#	}
		#}
		#ai_chance = {
		#	base = 80 # LotR: The AI has already made its choice - this is a last check for the player, but give a small chance for variety
		#}
	}
}