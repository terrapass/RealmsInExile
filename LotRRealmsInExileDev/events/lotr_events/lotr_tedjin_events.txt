namespace = tedjin

#Tedjin Faction Demand Events

tedjin.0001 = { # Faction Demand Notice
	type = letter_event
	sender = scope:faction_leader
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_SEND_DEMAND_NOTIFICATION"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_SEND_DEMAND_NOTIFICATION_DESC"

	option = {
		name = "FACTION_DEMAND_SEND_DEMAND_NOTIFICATION_OPT"	
	}
}

tedjin.0002 = {
	type = letter_event
	sender = scope:faction_leader
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_DESC"
	
	trigger = {
		exists = scope:faction # May have ceased to exist by the time this triggers
	}

	option = {
		name = "FACTION_DEMAND_ACCEPT"

		scope:faction = {
			every_faction_member = {
				trigger_event = tedjin.0003
			}
		}

		create_title_and_vassal_change = {
			type = faction_demand
			save_scope_as = change
			add_claim_on_loss = no
		}

		root = {
			save_scope_as = faction_target
			add_prestige = -500			
			add_dread = -30
			every_held_title = {
				change_title_holder = {
					holder = scope:faction_leader
					change = scope:change
				}
			}
		}
		
		resolve_title_and_vassal_change = scope:change

		ai_chance = {
			base = 1
			modifier = {
				add = 99
				scope:faction = { faction_power >= 100 }
			}
			modifier = {
				add = 50
				scope:faction = { faction_power >= 125 }
			}
			modifier = {
				add = 50
				scope:faction = { faction_power >= 150 }
			}
			modifier = {
				add = 50
				scope:faction = { faction_power >= 200 }
			}
			modifier = {
				factor = 0.1
				any_ally = {
					NOR = {
						target_is_liege_or_above = root
						target_is_vassal_or_below = root
					}
					max_military_strength > root.max_military_strength
				}
			}
			compare_modifier = {
				value = debt_level
				multiplier = 25
			}
			modifier = {
				add = -50
				scope:faction_target = {
					is_at_war = no
					primary_title.tier >= tier_kingdom
				}
			}
			modifier = {
				add = -150
				scope:faction_target = {
					is_at_war = no
					primary_title.tier >= tier_empire
				}
			}
		}
	}

	option = {
		name = "FACTION_DEMAND_REFUSE"

		show_as_tooltip = {
			scope:faction = {
				faction_start_war = {}
			}
		}
		
		root = {
			save_scope_as = faction_target
		}
		
		scope:faction_leader = {
			trigger_event = tedjin.0004
		}

		ai_chance = {
			base = 100
			ai_value_modifier = {
				ai_boldness = 4.0
			}
			modifier = {
				add = 50
				scope:faction = { faction_power < 80 }
			}
			modifier = {
				add = 100
				scope:faction = { faction_power < 60 }
			}
			modifier = {
				add = 1000
				scope:faction = { faction_power < 40 }
			}
			compare_modifier = {
				value = debt_level
				multiplier = -25
			}
		}
	}
}

tedjin.0003 = { #Acceptance notification
	type = letter_event
	sender = scope:faction_target
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_ACCEPTED"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_ACCEPTED_DESC"

	option = {
		name = "FACTION_DEMAND_ACCEPTED_OPT"
#		custom_tooltip = faction_demand.0002.tt
	}
}

tedjin.0004 = { #Refusal notification to leader
	type = letter_event
	sender = scope:faction_target
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_REFUSED"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_REFUSED_DESC"

	option = {
		name = "FACTION_DEMAND_REFUSED_OPT"
		scope:faction = {
			faction_start_war = {}
			
			every_faction_member = {
				limit = { NOT = { this = scope:faction.faction_leader } }
				trigger_event = tedjin.0005
			}
		}
	}
}

tedjin.0005 = { #Refusal notification to members
	type = letter_event
	sender = scope:faction_target
	opening = {
		desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_REFUSED"
	}
	desc = "FACTION_DEMAND_TEDJIN_CIVIL_WAR_REFUSED_DESC"

	option = {
		name = "FACTION_DEMAND_REFUSED_OPT"	
	}
}

# Tedjin Events
# Tedjin.0100 = Tedjin start-up events (Character intros)


tedjin.0100 = { # Introduction to Ayal, Kataj of the Confederacy
	title = tedjin.0100.t
	desc = tedjin.0100.desc
	theme = stewardship_duty_focus
	left_portrait = {
		character = root
		animation = worry
	}
	right_portrait = {
		character = character:lineofazumenakhad79
		animation = worry
	}
	
	option = { # All my work for naught...
		name = tedjin.0100.a
	}
}

tedjin.0101 = { # Handling of the Death of Ayal - check if Bor is successor
	title = tedjin.0101.t
	desc = tedjin.0101.desc
	theme = death
	left_portrait = {
		character = root
		animation = pain
	}

	trigger = {
		character:lineofthezij42 = root
	}
	
	option = { # Bor is the heir to the confederacy
		name = tedjin.0101.a
		trigger = {
			character:lineofthezij51 = {
				has_title = title:k_tedjin
			}
		}
		character:lineofthezij51 = {
			trigger_event = {
				id = tedjin.0102
				days = 1
			}
		}
	}
	
	option = { # Bor is not the heir to the confederacy
		name = tedjin.0101.b
		trigger = {
			character:lineofthezij51 = {
				NOT = { has_title = title:k_tedjin }
			}
		}
		##CIVIL WAR IS DEFUSED OUTCOME
	}
}

tedjin.0102 = { # Death of Ayal - Bor rules the Confederacy - things could get ugly
	title = tedjin.0102.t
	desc = tedjin.0102.desc
	theme = death
	left_portrait = {
		character = root
		animation = angry
	}
	
	option = { # Things are about to get messy...
		name = tedjin.0102.a
		if = { #If Gyuruchill II is still alive, cue countdown of death
			limit = {
				character:lineofazumenakhad79 = {
					is_alive = yes
				}
			}
			trigger_event = {
				id = tedjin.0104
				days = { 30 300 }
			}			
		}
		else = { #If Gyuruchill II is dead, then cue Bulga's appeal
			trigger_event = {
				id = tedjin.0105
				days = { 30 90 }
			}
		}
	}
}

tedjin.0103 = { # Bor decides how he should reign
	title = tedjin.0103.t
	desc = tedjin.0103.desc
	theme = death
	left_portrait = {
		character = root
		animation = angry
	}
	
	option = { # Reformist - A campaign of rigourous centralisation, conversion and modernisation
		name = tedjin.0103.a
		if = {
			limit = { has_realm_law = crown_authority_2 }
			add_realm_law = crown_authority_3
		}
		else_if = {
			limit = { has_realm_law = crown_authority_1 }
			add_realm_law = crown_authority_2
		}
		else_if = {
			limit = { has_realm_law = crown_authority_0 }
			add_realm_law = crown_authority_1
		} 
		add_character_modifier = {
			modifier = tedjin_reformer_modifier
		}
	}
	
	option = { # Moderate - A conventional ruler, trying to find the balance
		name = tedjin.0103.b
		stress_impact = {
			stubborn = medium_stress_impact_gain
		}
		if = {
			limit = { has_realm_law = crown_authority_1 }
			add_realm_law = crown_authority_0
		}
		else_if = {
			limit = { has_realm_law = crown_authority_2 }
			add_realm_law = crown_authority_1
		}
		else_if = {
			limit = { has_realm_law = crown_authority_3 }
			add_realm_law = crown_authority_2
		} 
		add_character_modifier = {
			modifier = tedjin_moderate_modifier
		}
	}
	
	option = { # Conservative - Reconvert and give vassals their traditional freedoms
		name = tedjin.0103.c
		stress_impact = {
			stubborn = medium_stress_impact_gain
			zealous = major_stress_impact_gain
		}
		remove_trait = zealous
		add_trait_force_tooltip = fickle
		set_character_faith = faith:faith_easterling_war
		add_piety_level = -1
		add_character_modifier = {
			modifier = reconverted_tedjin_modifier
			years = 25
		}
		if = {
			limit = {
				character:lineofazumenakhad81 = { is_alive = yes }
			}
			remove_relation_rival = character:lineofazumenakhad81
			set_relation_friend = character:lineofazumenakhad81
		}
		every_vassal = {
			limit = {
				OR = {
					has_government = feudal_government
				}
			}
			vassal_contract_set_obligation_level = {
				type = war_declaration_rights
				level = war_declaration_rights_allowed
			}
		}
		every_vassal = {
			limit = {
				dynasty = dynasty:dynasty_azumenakhad
			}
			vassal_contract_set_obligation_level = {
				type = council_rights
				level = council_rights_guaranteed
			}			
		}
		every_vassal = {
			limit = {
				NOT = { faith = faith:faith_easterling_war } 
			}
			add_character_modifier = {
				modifier = reconverted_tedjin_liege_modifier
			}			
		}
	}
	
	option = { # Secession - Split the realm along faith lines
		name = tedjin.0103.d
		
		stress_impact = {
			stubborn = major_stress_impact_gain
		}
		
		if = {
			limit = {
				character:lineofazumenakhad81 = { is_alive = yes }
			}
			remove_relation_rival = character:lineofazumenakhad81
		}
		
		create_title_and_vassal_change = {
			type = faction_demand
			save_scope_as = change
			add_claim_on_loss = no
		}
		
		title:k_tedjin = {
			change_title_holder = {
				holder = character:lineofazumenakhad81
				change = scope:change
			}
		}

		every_vassal = {
			limit = {
				has_faith = faith:faith_easterling_war
			}
			
			change_liege = {
				liege = character:lineofazumenakhad81
				change = scope:change
			}		
		}
			
		resolve_title_and_vassal_change = scope:change

		get_title = k_soriya

		set_culture = culture:soriyan
		
		every_child = {
			set_culture = culture:soriyan
		}

		character:lineofazumenakhad81 = { #Notify and resolve for Azumen, transfer faithful vassals to Soriya
			trigger_event = tedjin.0107
		}
		
	}
}

tedjin.0104 = { # Death of Gyuruchill II
	hidden = yes
	
	immediate = { # Kill Gyuruchill II
		if = { #If Gyuruchill II is still alive after countdown, kill
			limit = {
				character:lineofazumenakhad79 = {
					is_alive = yes
				}
			}
			character:lineofazumenakhad79 = {
				death = natural
			}			
		}
		character:lineofthezij51 = {		
			trigger_event = { #Cue Bulga's appeal
				id = tedjin.0105
				days = 30
			}
		}
	}
}

tedjin.0105 = { # Bor's perspective - send out for Bulga's appeal
	title = tedjin.0105.t
	desc = tedjin.0105.desc
	theme = diplomacy
	left_portrait = {
		character = root
		animation = personality_cynical
	}
	right_portrait = {
		character = character:lineofazumenakhad87
		animation = beg
	}
	
	option = { # Kill Gyuruchill II
		name = tedjin.0105.a
		character:lineofazumenakhad81 = {
			trigger_event = { # Bulga goes on her way
				id = tedjin.0106
				days = { 30 60 }
			}
		}
	}
}

tedjin.0106 = { # Bulga's appeal
	title = tedjin.0106.t
	desc = tedjin.0106.desc
	theme = death
	left_portrait = {
		character = root
		animation = stress
	}
	right_portrait = {
		character = character:lineofazumenakhad87
		animation = beg
	}
	
	option = { # Ignore her pleas
		name = tedjin.0106.a
		add_piety = 150
		#add_character_modifier = { 
		#	modifier = #Potentially make it harder to kill him with schemes
		#}
		##CUE FOREIGN SUPPORT
		#character:lineofthezij51 = {		
		#	trigger_event = { #Bulga returns disappointed
		#		id = tedjin.0103
		#		days = 1
		#	}
		#}
		create_faction = {
			type = tedjin_civil_war_faction  #tedjin_civil_war_faction
			target = character:lineofthezij51
		}
	}
	
	option = { # Relent and convert
		name = tedjin.0106.b
		stress_impact = {
			zealous = major_stress_impact_gain
		}
		set_character_faith_with_conversion = faith:faith_path_of_wisdom
		add_piety_level = -1
		add_character_modifier = {
			modifier = reconverted_tedjin_modifier
			years = 25
		}
		remove_trait = zealous
		add_trait_force_tooltip = fickle
		if = {
			limit = {
				character:lineofthezij51 = { is_alive = yes }
			}
			remove_relation_rival = character:lineofthezij51
			set_relation_friend = character:lineofthezij51
		}
		##TRIGGER NOTIFICATION OF WAR
	}
}

tedjin.0107 = { # Secession resolution
	hidden = yes
	
	immediate = { # transfer faithful vassals to Soriya

		create_title_and_vassal_change = {
			type = faction_demand
			save_scope_as = change
			add_claim_on_loss = no
		}

		every_vassal = {
			limit = {
				has_faith = faith:faith_path_of_wisdom
			}
			
			change_liege = {
				liege = character:lineofthezij51
				change = scope:change
			}			
		}

		resolve_title_and_vassal_change = scope:change
		
	}
}

tedjin.0200 = { # The Civil War begins
	title = tedjin.0200.t
	desc = tedjin.0200.desc
	theme = vassal
	left_portrait = {
		character = root
		animation = stress
	}
	
	option = { 
		name = tedjin.0200.a # Cave to their demands
		#every_vassal = { # Notify the lords!
		#	trigger_event = {
		#		#id = gondor.0556
		#	}		
		#}
		#character:lineisildur42 = { # Aragorn is allowed into Minas Tirith
		#	trigger_event = {
		#		id = gondor.0502
		#		days = { 30 60 }
		#	}
		#}
		#ai_chance = {
		#	base = 20 # LotR: The AI has already made its choice - this is a last check for the player, but give a small chance for variety
		#}
	}
	
	option = { 
		name = tedjin.0200.b # I shall not be blackmailed... to war!
		# Start war
		#title:k_belfalas.holder = { # Notify the Rebel Leader
		#	start_war = { 
		#		casus_belli = kingstrife_cb
		#		target = root
		#	}
		#	trigger_event = {
		#		id = gondor.0557
		#	}
		#}
		#every_vassal = { # Let all other lords pick their side
		#	limit = {
		#		NOT = { has_title = title:k_belfalas }
		#	}
		#	trigger_event = {
		#		id = gondor.0558
		#		days = 1
		#	}		
		#}
		#title:e_mordor.holder = { # Notify Sauron after some time
		#	trigger_event = {
		#		id = gondor.0559
		#		days = { 30 180 }
		#	}
		#}
		#every_living_character = {
		#	limit = {
		#		NOT = { root = this }
		#	}
		#	trigger_event = { 
		#		id = gondor.0560
		#		days = 14
		#	}
		#}
		#ai_chance = {
		#	base = 80 # LotR: The AI has already made its choice - this is a last check for the player, but give a small chance for variety
		#}
	}
}