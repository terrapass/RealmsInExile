namespace = abrakhan

# Abrakhân Missions
#	abrakhan.1001	Loredump
#	abrakhan.1002	Mission unlock 1. Choice of initial buff.
#					(A) Dune Sea
#					(B) Nâfarati
#					(C) Mahûd
#	abrakhan.1003	




abrakhan.1001 = {
	type = character_event
	title = abrakhan.1001.t
	desc = abrakhan.1001.desc
	theme = martial
	left_portrait = {
		character = scope:goldenking
		animation = nazgul_pose_idle
	}
	right_portrait = {
		character = scope:sauron
		animation = personality_greedy
	}
	immediate = {
		play_music_cue = "The_Altar_of_Melkor"
		root = { save_scope_as = goldenking }
		character:lineofsauron = { save_scope_as = sauron }
	}

	trigger = {
		character_is_valid_for_abrakhan_subjugation_mission_trigger = yes
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = abrakhan.1001
				days = { 100 900 }
			}
		}
	}

	option = {
		name = abrakhan.1001.a
		ai_chance = { base = 100 }
		trigger_event = abrakhan.1002
	}
}

abrakhan.1002 = {
	type = character_event
	title = abrakhan.1002.t
	desc = {
		desc = abrakhan.1002.desc_start
		triggered_desc = {
			trigger = {
				NOT = { has_character_flag = abrakhan_subjugation_dune_sea_decision }
				NOT = { completely_controls = title:e_dune_sea }
			}
			desc = abrakhan.1002.desc_dune_sea
		}
		triggered_desc = {
			trigger = {
				NOT = { has_character_flag = abrakhan_subjugation_nafarati_decision }
				NOT = { completely_controls = title:e_abrakhan }
			}
			desc = abrakhan.1002.desc_nafarati
		}
		triggered_desc = {
			trigger = {
				NOT = { has_character_flag = abrakhan_subjugation_mahud_decision }
			}
			desc = abrakhan.1002.desc_mahud
		}
		triggered_desc = {
			trigger = {
				NOT = { has_character_flag = abrakhan_subjugation_ray_decision }
				NOT = { completely_controls = title:e_bozisha_miraz }
			}
			desc = abrakhan.1002.desc_ray
		}
		triggered_desc = {
			trigger = {
				NOT = { has_character_flag = abrakhan_subjugation_bellakar_decision }
				NOT = { completely_controls = title:k_mardruak }
			}
			desc = abrakhan.1002.desc_bellakar
		}
		triggered_desc = {
			trigger = {
				NOT = { has_character_flag = abrakhan_subjugation_mardruak_decision }
				NOT = { completely_controls = title:e_abrakhan }
			}
			desc = abrakhan.1002.desc_mardruak
		}
		triggered_desc = {
			trigger = {
				NOT = { has_character_flag = abrakhan_subjugation_near_harad_decision }
				NOT = { completely_controls = title:e_haradwaith }
			}
			desc = abrakhan.1002.desc_near_harad
		}
		triggered_desc = {
			trigger = {
				NOT = { has_character_flag = abrakhan_subjugation_umbar_decision }
				NOT = { completely_controls = title:e_umbar }
			}
			desc = abrakhan.1002.desc_umbar
		}
		desc = abrakhan.1002.desc_end
	}
	theme = martial
	left_portrait = {
		character = scope:goldenking
		animation = nazgul_pose_idle
	}

	trigger = {
		character_is_valid_for_abrakhan_subjugation_mission_trigger = yes
	}
	on_trigger_fail = {
		if = {
			limit = { is_ai = no }
			trigger_event = {
				id = abrakhan.1002
				days = { 900 1800 }
			}
		}
	}

	option = { # Dune Sea
		name = abrakhan.1002.a
		custom_tooltip = abrakhan.1002.a.tt
		custom_tooltip = abrakhan.1002.a.tt2
		option_abrakhan_subjugation_dune_sea_effect = yes
		ai_chance = { base = 10 }
	}
	option = { # Nâfarati
		name = abrakhan.1002.b
		custom_tooltip = abrakhan.1002.a.tt
		custom_tooltip = abrakhan.1002.a.tt2
		option_abrakhan_subjugation_nafarati_effect = yes
		ai_chance = { base = 10 }
	}
#	option = { # Mahûd
#		name = abrakhan.1002.a
#		custom_tooltip = abrakhan.1002.a.tt
#		custom_tooltip = abrakhan.1002.a.tt2
#		option_abrakhan_subjugation_mahud_effect = yes
#		ai_chance = { base = 10 }
#	}
}

abrakhan.1003 = {
	type = character_event
	title = abrakhan.1003.t
	desc = abrakhan.1003.desc
	theme = realm
	right_portrait = {
		character = scope:goldenking
		animation = nazgul_pose_idle
	}
	left_portrait = {
		character = scope:nearby_ruler
		animation = personality_cynical
	}
	immediate = {
		play_music_cue = "Influence_of_Sauron"
		if = {
			limit = {
				AND = {
					exists = title:k_abrakhan.holder
					character_is_valid_for_abrakhan_subjugation_mission_trigger = yes
				}
			}
			title:k_abrakhan.holder = {
				save_scope_as = goldenking
			}
		}
		else_if = {
			character:lineofsauron = { save_scope_as = sauron }
		}
		cp:councillor_court_chaplain = {
			save_scope_as = realm_priest
		}
	}

	option = { # Ill omen.
		name = abrakhan.1003.a
		custom_tooltip = abrakhan.1003.a.tt
		ai_chance = { base = 20 }
		abrakhan_carrion_feeder_effect = yes
		scope:nearby_ruler = { save_scope_as = defiant_to_abrakhan }
		scope:goldenking = { trigger_event = abrakhan.1005 }
	}
	option = { # Submit to Abrakhân.
		name = abrakhan.1003.b
		custom_tooltip = abrakhan.1003.b.tt
		submit_to_abrakhan_effect = yes
		scope:nearby_ruler = { save_scope_as = submitted_to_abrakhan }
		scope:goldenking = { trigger_event = abrakhan.1004 }
		ai_chance = {
			base = 0
			modifier = {
				add = 100
				OR = {
					# Worships Sauron.
					has_faith = faith:lidless_eye
					has_faith = faith:sons_of_sauron
					has_faith = faith:red_eye_cult
					has_faith = faith:melkorite
					has_faith = faith:faith_kanra
					# Is a ruined form of life.
					is_undead = yes
					is_orc = yes
					has_religion = religion:forces_of_evil_religion
				}
			}
			modifier = {
				add = 10
				# Ancients worshiped Sauron.
				has_religion = religion:darkness_religion
			}
			modifier = {
				factor = 0.5
				OR = {
					# Dune Sea and Khand resist (for bordergore reasons).
					has_culture_group = culture_group:lotr_sandmen_group
					has_culture_group = culture_group:lotr_ioriag_group
				}
			}
			modifier = {
				add = 5
				highest_held_title_tier = tier_county
			}
			modifier = {
				factor = 2
				has_game_rule = default_ai_behavior
			}
			modifier = {
				factor = 0
				has_game_rule = random_ai_behavior
			}
			modifier = {
				factor = 0.5
				highest_held_title_tier >= tier_duchy
			}
			modifier = {
				factor = 0.5
				realm_size >= 5
			}
			modifier = {
				factor = 0
				realm_size >= 20
			}
			modifier = {
				factor = 0.5
				OR = {
					has_trait = brave
					has_trait = stubborn
					has_trait = vengeful
					has_trait = cynical
				}
			}
			opinion_modifier = {
				who = scope:nearby_ruler
				opinion_target = scope:goldenking
				multiplier = 0.5
				desc = AI_OPINION_REASON
			}
			modifier = {
				add = 10
				scope:nearby_ruler = {
					NOT = { target_is_liege_or_above = scope:goldenking }
					has_dread_level_towards = {
						target = scope:goldenking
						level = 1
					}
				}
			}
			modifier = {
				add = 20
				scope:nearby_ruler = {
					NOT = { target_is_liege_or_above = scope:goldenking }
					has_dread_level_towards = {
						target = scope:goldenking
						level = 2
					}
				}
			}
		}
	}
	option = { # Praise Zigûr!
		name = abrakhan.1003.c
		custom_tooltip = abrakhan.1003.b.tt
		custom_tooltip = abrakhan.1003.b.tt2
		trigger = { has_religion = religion:forces_of_evil_religion }
		exclusive = yes
		submit_to_abrakhan_effect = yes
		scope:nearby_ruler = { save_scope_as = submitted_to_abrakhan }
		scope:goldenking = { trigger_event = abrakhan.1004 }
	}
}
abrakhan.1004 = {
	type = letter_event
	opening = abrakhan.1004.opening
	desc = abrakhan.1004.desc
	sender = scope:submitted_to_abrakhan

	immediate = {
	}

	option = {
		name = abrakhan.1004.a
	}
}
abrakhan.1005 = {
	hidden = yes
	type = empty
	sender = scope:defiant_to_abrakhan
	immediate = {
		random_list = {
			5 = {
				if = { # AI Golden King forced to declare war.
					limit = {
						scope:goldenking = { is_ai = yes }
						has_game_rule = default_ai_behavior
					}
					scope:defiant_to_abrakhan.primary_title = {
						save_scope_as = target_title
					}
					scope:goldenking = {
						trigger_event = {
							id = abrakhan.1006
							days = { 300 900 }
						}
					}
				}
				else_if = {
					limit = {
						scope:goldenking = { is_ai = yes }
						has_game_rule = weighted_ai_behavior
					}
					scope:defiant_to_abrakhan.primary_title = {
						save_scope_as = target_title
					}
					scope:goldenking = {
						trigger_event = {
							id = abrakhan.1006
							days = { 600 2100 }
						}
					}
				}
			}
			15 = { }
		}
		
	}
	option = {
		name = abrakhan.1004.a
	}
}
abrakhan.1006 = {
	hidden = yes
	type = empty
	immediate = {
		if = {
			limit = { scope:goldenking = { is_ai = yes } }
			if = {
				limit = { exists = scope:target_title.duchy }
				start_war = {
					cb = invasion_war
					target = scope:target_title.holder
					target_title = scope:target_title.duchy
				}
			}
			else = { }
			add_gold = massive_gold_value
			add_prestige = massive_prestige_value
		}
	}
}







