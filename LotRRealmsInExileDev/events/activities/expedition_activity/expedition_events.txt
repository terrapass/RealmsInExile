# Events for handling the Mining activity

namespace = expedition

scripted_trigger can_replace_councillor = { 
	NOT = { this = scope:$SAVED_SCOPE$ }
	$SPECIALTY$ > $SKILL$
	NOT = { is_close_family_of = root }
	is_ruler = no
}

scripted_effect fire_appropriate_event = {
	if = { # Marshal
		limit = {
			NOR = {
				exists = scope:primary_replaced_marshal
				exists = scope:secondary_replaced_marshal
			}
			cp:councillor_marshal = { is_landed = yes }
		}
		trigger_event = expedition.0001
	}
	else_if = { # Diplomat
		limit = {
			NOR = {
				exists = scope:primary_replaced_diplomat
				exists = scope:secondary_replaced_diplomat
			}
			cp:councillor_chancellor = { is_landed = yes }
		}
		trigger_event = expedition.0002
	}
	else_if = { # Steward
		limit = {
			NOR = {
				exists = scope:primary_replaced_steward
				exists = scope:secondary_replaced_steward
			}
			cp:councillor_steward = { is_landed = yes }
		}
		trigger_event = expedition.0003
	}
	else = { # Spymaster
		if = {
			limit = {
				NOR = {
					exists = scope:primary_replaced_spymaster
					exists = scope:secondary_replaced_spymaster
				}
				cp:councillor_spymaster = { is_landed = yes }
			}
			trigger_event = expedition.0004
		}
	}
}

# Selecting councillors (Marshal) --> Moving your realm
expedition.0001 = {
	title = expedition.0001.t
	desc = expedition.0001.desc

	override_background = {
		reference = throne_room_dwarf
	}

	right_portrait = {
		character = root
		animation = thinking
	}

	left_portrait = scope:primary_replaced_marshal

	lower_center_portrait = scope:secondary_replaced_marshal


	immediate = {
		cp:councillor_marshal = { save_scope_as = current_marshal }
		random_knight = { # Marshals
			limit = {
				NOT = { this = scope:primary_replaced_marshal }
				martial > 12
				NOT = { is_close_family_of = root }
				is_ruler = no
			}
			save_scope_as = primary_replaced_marshal
		}
		random_courtier = {
			limit = {
				NOT = { this = scope:primary_replaced_marshal }
				martial > 10
				NOT = { is_close_family_of = root }
				is_ruler = no
			}
			save_scope_as = secondary_replaced_marshal
		}

		if = {
			limit = { NOT = { exists = scope:primary_replaced_marshal } }
			random_courtier = {
				limit = {
					NOT = { this = scope:secondary_replaced_marshal }
					martial > 10
					NOT = { is_close_family_of = root }
					is_ruler = no
				}
				save_scope_as = primary_replaced_marshal
			}
		}
		if = {
			limit = { NOT = { exists = scope:secondary_replaced_marshal } }
			random_courtier = {
				limit = {
					NOT = { this = scope:primary_replaced_marshal }
					martial > 8
					NOT = { is_close_family_of = root }
					is_ruler = no
				}
				save_scope_as = secondary_replaced_marshal
			}
		}

		### Fallback if no courtiers were found at all:
		if = {
			limit = { NOT = { exists = scope:primary_replaced_marshal } }
			create_character = {
				location = root.capital_province
				gender_female_chance = 50
				template_character = scope:elven_friend
				culture = root.culture
				faith = root.faith
				random_traits = yes
				save_scope_as = primary_replaced_marshal
					
				after_creation = {
					if = {
						limit = { is_elf = yes }
						change_age = { 100 6950 }
						replace_unelven_traits = yes
					}
					if = {
						limit = { is_dwarf = yes }
						change_age = { 0 240 }
					}
				}
			}
		}
		if = {
			limit = { NOT = { exists = scope:secondary_replaced_marshal } }
			create_character = {
				location = root.capital_province
				gender_female_chance = 50
				template_character = scope:elven_friend
				culture = root.culture
				faith = root.faith
				random_traits = yes
				save_scope_as = secondary_replaced_marshal
					
				after_creation = {
					if = {
						limit = { is_elf = yes }
						change_age = { 100 6950 }
						replace_unelven_traits = yes
					}
					if = {
						limit = { is_dwarf = yes }
						change_age = { 0 240 }
					}
				}
			}
		}
	}

	option = { # Pick first option to become new marshal on arrival
		name = expedition.0001.a

		trigger = { exists = scope:primary_replaced_marshal }

		scope:primary_replaced_marshal = {
			set_variable = replaced_marshal
		}
	}
	option = { # Pick second option to become new marshal on arrival
		name = expedition.0001.b

		trigger = { exists = scope:secondary_replaced_marshal }

		scope:secondary_replaced_marshal = {
			set_variable = replaced_marshal
		}
	}
	option = { # Stick with old marshal
		name = expedition.0001.c

		trigger = {
			scope:current_marshal = {
				is_ruler = no
				NOT = { is_close_family_of = root }
			}
		}

		scope:current_marshal = { set_variable = replaced_marshal }
	}

	after = { fire_appropriate_event = yes }
}

# Selecting councillors (Diplomat) --> Moving your realm
expedition.0002 = {
	title = expedition.0002.t
	desc = expedition.0002.desc

	override_background = {
		reference = throne_room_dwarf
	}

	right_portrait = {
		character = root
		animation = thinking
	}

	left_portrait = scope:primary_replaced_diplomat

	lower_center_portrait = scope:secondary_replaced_diplomat

	immediate = {
		cp:councillor_chancellor = { save_scope_as = current_chancellor }
		random_knight = { # Diplomats
			limit = {
				NOT = { this = scope:primary_replaced_diplomat }
				diplomacy > 12
				NOT = { is_close_family_of = root }
				is_ruler = no
			}
			save_scope_as = primary_replaced_diplomat
		}
		random_courtier = {
			limit = {
				NOT = { this = scope:primary_replaced_diplomat }
				diplomacy > 10
				NOT = { is_close_family_of = root }
				is_ruler = no
			}
			save_scope_as = secondary_replaced_diplomat
		}

		if = {
			limit = { NOT = { exists = scope:primary_replaced_diplomat } }
			random_courtier = {
				limit = {
					NOT = { this = scope:secondary_replaced_diplomat }
					diplomacy > 10
					NOT = { is_close_family_of = root }
					is_ruler = no
				}
				save_scope_as = primary_replaced_diplomat
			}
		}
		if = {
			limit = { NOT = { exists = scope:secondary_replaced_diplomat } }
			random_courtier = {
				limit = {
					NOT = { this = scope:primary_replaced_diplomat }
					diplomacy > 8
					NOT = { is_close_family_of = root }
					is_ruler = no 
				}
				save_scope_as = secondary_replaced_diplomat
			}
		}
		

		### Fallback if no courtiers were found at all:
		if = {
			limit = { NOT = { exists = scope:primary_replaced_diplomat } }
			create_character = {
				location = root.capital_province
				gender_female_chance = 50
				template_character = scope:elven_friend
				culture = root.culture
				faith = root.faith
				random_traits = yes
				save_scope_as = primary_replaced_diplomat
					
				after_creation = {
					if = {
						limit = { is_elf = yes }
						change_age = { 100 6950 }
						replace_unelven_traits = yes
					}
					if = {
						limit = { is_dwarf = yes }
						change_age = { 0 240 }
					}
				}
			}
		}
		if = {
			limit = { NOT = { exists = scope:secondary_replaced_diplomat } }
			create_character = {
				location = root.capital_province
				gender_female_chance = 50
				template_character = scope:elven_friend
				culture = root.culture
				faith = root.faith
				random_traits = yes
				save_scope_as = secondary_replaced_diplomat
					
				after_creation = {
					if = {
						limit = { is_elf = yes }
						change_age = { 100 6950 }
						replace_unelven_traits = yes
					}
					if = {
						limit = { is_dwarf = yes }
						change_age = { 0 240 }
					}
				}
			}
		}
	}

	option = {
		name = expedition.0002.a

		trigger = { exists = scope:primary_replaced_diplomat }

		scope:primary_replaced_diplomat = {
			set_variable = replaced_diplomat
		}
	}
	option = {
		name = expedition.0002.b

		trigger = { exists = scope:secondary_replaced_diplomat }

		scope:secondary_replaced_diplomat = {
			set_variable = replaced_diplomat
		}
	}
	option = { # Stick with old marshal
		name = expedition.0002.c

		trigger = {
			scope:current_chancellor = {
				is_ruler = no
				NOT = { is_close_family_of = root }
			}
		}

		scope:current_chancellor = { set_variable = replaced_diplomat }
	}

	after = { fire_appropriate_event = yes }
}

# Selecting councillors (Steward) --> Moving your realm
expedition.0003 = {
	title = expedition.0003.t
	desc = expedition.0003.desc

	override_background = {
		reference = throne_room_dwarf
	}

	right_portrait = {
		character = root
		animation = thinking
	}

	left_portrait = scope:primary_replaced_steward

	lower_center_portrait = scope:secondary_replaced_steward

	immediate = {
		cp:councillor_steward = { save_scope_as = current_steward }
		random_knight = { # Stewards
			limit = {
				NOT = { this = scope:primary_replaced_steward }
				stewardship > 12
				NOT = { is_close_family_of = root }
				is_ruler = no 
				NOR = {
					has_variable = replaced_marshal
					has_variable = replaced_diplomat
				}
			}
			save_scope_as = primary_replaced_steward
		}
		random_courtier = {
			limit = {
				NOT = { this = scope:primary_replaced_steward }
				stewardship > 10
				NOT = { is_close_family_of = root }
				is_ruler = no 
				NOR = {
					has_variable = replaced_marshal
					has_variable = replaced_diplomat
				}
			}
			save_scope_as = secondary_replaced_steward
		}

		if = {
			limit = { NOT = { exists = scope:primary_replaced_steward } }
			random_courtier = {
				limit = {
					NOT = { this = scope:secondary_replaced_steward }
					stewardship > 10
					NOT = { is_close_family_of = root }
					is_ruler = no 
					NOR = {
						has_variable = replaced_marshal
						has_variable = replaced_diplomat
					}
				}
				save_scope_as = primary_replaced_steward
			}
		}
		if = {
			limit = { NOT = { exists = scope:secondary_replaced_steward } }
			random_courtier = {
				limit = {
					NOT = { this = scope:primary_replaced_steward }
					stewardship > 8
					NOT = { is_close_family_of = root }
					is_ruler = no 
					NOR = {
						has_variable = replaced_marshal
						has_variable = replaced_diplomat
					}
				}
				save_scope_as = secondary_replaced_steward
			}
		}
		

		### Fallback if no courtiers were found at all:
		if = {
			limit = { NOT = { exists = scope:primary_replaced_steward } }
			create_character = {
				location = root.capital_province
				gender_female_chance = 50
				template_character = scope:elven_friend
				culture = root.culture
				faith = root.faith
				random_traits = yes
				save_scope_as = primary_replaced_steward
					
				after_creation = {
					if = {
						limit = { is_elf = yes }
						change_age = { 100 6950 }
						replace_unelven_traits = yes
					}
					if = {
						limit = { is_dwarf = yes }
						change_age = { 0 240 }
					}
				}
			}
		}
		if = {
			limit = { NOT = { exists = scope:secondary_replaced_steward } }
			create_character = {
				location = root.capital_province
				gender_female_chance = 50
				template_character = scope:elven_friend
				culture = root.culture
				faith = root.faith
				random_traits = yes
				save_scope_as = secondary_replaced_steward
					
				after_creation = {
					if = {
						limit = { is_elf = yes }
						change_age = { 100 6950 }
						replace_unelven_traits = yes
					}
					if = {
						limit = { is_dwarf = yes }
						change_age = { 0 240 }
					}
				}
			}
		}
	}

	option = {
		name = expedition.0003.a

		trigger = { exists = scope:primary_replaced_steward }

		scope:primary_replaced_steward = {
			set_variable = replaced_steward
		}
	}
	option = {
		name = expedition.0003.b

		trigger = { exists = scope:secondary_replaced_steward }

		scope:secondary_replaced_steward = {
			set_variable = replaced_steward
		}
	}
	option = { # Stick with old marshal
		name = expedition.0003.c

		trigger = {
			scope:current_steward = {
				is_ruler = no
				NOT = { is_close_family_of = root }
			}
		}

		scope:current_steward = { set_variable = replaced_steward }
	}

	after = { fire_appropriate_event = yes }
}

# Selecting councillors (Spymaster) --> Moving your realm
expedition.0004 = {
	title = expedition.0004.t
	desc = expedition.0004.desc

	override_background = {
		reference = throne_room_dwarf
	}

	right_portrait = {
		character = root
		animation = thinking
	}

	left_portrait = scope:primary_replaced_spymaster

	lower_center_portrait = scope:secondary_replaced_spymaster

	immediate = {
		cp:councillor_spymaster = { save_scope_as = current_spymaster }
		random_knight = { # Spymasters
			limit = {
				NOT = { this = scope:primary_replaced_spymaster }
				intrigue > 12
				NOT = { is_close_family_of = root }
				is_ruler = no 
				NOR = {
					has_variable = replaced_marshal
					has_variable = replaced_diplomat
					has_variable = replaced_steward
				}
			}
			save_scope_as = primary_replaced_spymaster
		}
		random_courtier = {
			limit = {
				NOT = { this = scope:primary_replaced_spymaster }
				intrigue > 10
				NOT = { is_close_family_of = root }
				is_ruler = no 
				NOR = {
					has_variable = replaced_marshal
					has_variable = replaced_diplomat
					has_variable = replaced_steward
				}
			}
			save_scope_as = secondary_replaced_spymaster
		}

		if = {
			limit = { NOT = { exists = scope:primary_replaced_spymaster } }
			random_courtier = {
				limit = {
					NOT = { this = scope:secondary_replaced_spymaster }
					intrigue > 10
					NOT = { is_close_family_of = root }
					is_ruler = no 
					NOR = {
						has_variable = replaced_marshal
						has_variable = replaced_diplomat
						has_variable = replaced_steward
					}
				}
				save_scope_as = primary_replaced_spymaster
			}
		}
		if = {
			limit = { NOT = { exists = scope:secondary_replaced_spymaster } }
			random_courtier = {
				limit = {
					NOT = { this = scope:primary_replaced_spymaster }
					intrigue > 8
					NOT = { is_close_family_of = root }
					is_ruler = no 
					NOR = {
						has_variable = replaced_marshal
						has_variable = replaced_diplomat
						has_variable = replaced_steward
					}
				}
				save_scope_as = secondary_replaced_spymaster
			}
		}
		

		### Fallback if no courtiers were found at all:
		if = {
			limit = { NOT = { exists = scope:primary_replaced_spymaster } }
			create_character = {
				location = root.capital_province
				gender_female_chance = 50
				template_character = scope:elven_friend
				culture = root.culture
				faith = root.faith
				random_traits = yes
				save_scope_as = primary_replaced_spymaster
					
				after_creation = {
					if = {
						limit = { is_elf = yes }
						change_age = { 100 6950 }
						replace_unelven_traits = yes
					}
					if = {
						limit = { is_dwarf = yes }
						change_age = { 0 240 }
					}
				}
			}
		}
		if = {
			limit = { NOT = { exists = scope:secondary_replaced_spymaster } }
			create_character = {
				location = root.capital_province
				gender_female_chance = 50
				template_character = scope:elven_friend
				culture = root.culture
				faith = root.faith
				random_traits = yes
				save_scope_as = secondary_replaced_spymaster
					
				after_creation = {
					if = {
						limit = { is_elf = yes }
						change_age = { 100 6950 }
						replace_unelven_traits = yes
					}
					if = {
						limit = { is_dwarf = yes }
						change_age = { 0 240 }
					}
				}
			}
		}
	}

	option = {
		name = expedition.0004.a

		trigger = { exists = scope:primary_replaced_spymaster }

		scope:primary_replaced_spymaster = { set_variable = replaced_spymaster }
	}
	option = {
		name = expedition.0004.b

		trigger = { exists = scope:secondary_replaced_spymaster }

		scope:secondary_replaced_spymaster = { set_variable = replaced_spymaster }
	}
	option = { # Stick with old marshal
		name = expedition.0004.c

		trigger = {
			scope:current_spymaster = {
				is_ruler = no
				NOT = { is_close_family_of = root }
			}
		}

		scope:current_spymaster = { set_variable = replaced_spymaster }
	}

	after = { fire_appropriate_event = yes }
}

# Maintenance event for expedition.0001 - 0004
expedition.0005 = {
	# hidden = yes

	immediate = {
		root.involved_activity = {
			save_scope_as = activity
		}

		if = { # Marshal
			limit = { any_knight = { has_variable = replaced_marshal } }
			random_knight = {
				limit = { has_variable = replaced_marshal }
				root.current_travel_plan ?= { add_companion = prev }
			}
		}
		else_if = {
			limit = { any_courtier = { has_variable = replaced_marshal } }
			random_courtier = {
				limit = { has_variable = replaced_marshal }
				root.current_travel_plan ?= { add_companion = prev }
			}
		}
		else = {
			if = {
				limit = { cp:councillor_marshal = { has_variable = replaced_marshal } }
			}
			cp:councillor_marshal = { root.current_travel_plan ?= { add_companion = prev } } 
		}
		
		if = { # Diplomat
			limit = { any_knight = { has_variable = replaced_diplomat } }
			random_knight = {
				limit = { has_variable = replaced_diplomat }
				root.current_travel_plan ?= { add_companion = prev }
			}
		}
		else_if = {
			limit = { any_courtier = { has_variable = replaced_diplomat } }
			random_courtier = {
				limit = { has_variable = replaced_diplomat }
				root.current_travel_plan ?= { add_companion = prev }
			}
		}
		else = {
			if = {
				limit = { cp:councillor_chancellor = { has_variable = replaced_diplomat } }
			}
			cp:councillor_chancellor = { root.current_travel_plan ?= { add_companion = prev } } 
		}
		
		if = { # Steward
			limit = { any_knight = { has_variable = replaced_steward } }
			random_knight = {
				limit = { has_variable = replaced_steward }
				root.current_travel_plan ?= { add_companion = prev }
			}
		}
		else_if = {
			limit = { any_courtier = { has_variable = replaced_steward } }
			random_courtier = {
				limit = { has_variable = replaced_steward }
				root.current_travel_plan ?= { add_companion = prev }
			}
		}
		else = {
			if = {
				limit = { cp:councillor_steward = { has_variable = replaced_steward } }
			}
			cp:councillor_steward = { root.current_travel_plan ?= { add_companion = prev } } 
		}

		if = { # Spymaster
			limit = { any_knight = { has_variable = replaced_spymaster } }
			random_knight = {
				limit = { has_variable = replaced_spymaster }
				root.current_travel_plan ?= { add_companion = prev }
			}
		}
		else_if = {
			limit = { any_courtier = { has_variable = replaced_spymaster } }
			random_courtier = {
				limit = { has_variable = replaced_spymaster }
				root.current_travel_plan ?= { add_companion = prev }
			}
		}
		else = {
			if = {
				limit = { cp:councillor_spymaster = { has_variable = replaced_spymaster } }
			}
			cp:councillor_spymaster = { root.current_travel_plan ?= { add_companion = prev } } 
		}
	}

	option = {
		name = " a "
	}
}

# Working on settlement
expedition.1000 = {
	title = expedition.1000.t
	desc = expedition.1000.desc

	override_background = {
		reference = mining_activity
	}
	left_portrait = {
		character = scope:host
		animation = thinking
	}

	option = {
		name = expedition.1000.a
	}
	option = {
		name = expedition.1000.b
	}
}

scripted_effect assign_new_councillor = {
	assign_councillor_type = { # Marshal
		type = $TYPE$
		remove_existing_councillor = yes
		target = $TARGET$
	}
}

# Maintenance event for end of activity --> Moving Realm
expedition.9000 = {
	hidden = yes

	immediate = { 

		current_travel_plan = { # Marshal
			random_entourage_character = { 
				limit = { has_variable = replaced_marshal }
				save_scope_as = replaced_marshal
				set_variable = {
					name = block_fire_councillor
					value = root
					years = 5
				}
			}
		}
		current_travel_plan = { # Diplomat
			random_entourage_character = {
			limit = { has_variable = replaced_diplomat }
			save_scope_as = replaced_diplomat
			set_variable = {
				name = block_fire_councillor
				value = root
				years = 5
			}
			}
		}
		current_travel_plan = { # Steward
			random_entourage_character = {
				limit = { has_variable = replaced_steward }
				save_scope_as = replaced_steward
				set_variable = {
					name = block_fire_councillor
					value = root
					years = 5
				}
			}
		}
		current_travel_plan = { # Spymaster
			random_entourage_character = {
				limit = { has_variable = replaced_spymaster }
				save_scope_as = replaced_spymaster
				set_variable = {
					name = block_fire_councillor
					value = root
					years = 5
				}
			}
		}

		assign_new_councillor = { # Marshal
			TYPE = councillor_marshal
			TARGET = scope:replaced_marshal
		}
		assign_new_councillor = { # Diplomat
			TYPE = councillor_chancellor
			TARGET = scope:replaced_diplomat
		}
		assign_new_councillor = { # Steward
			TYPE = councillor_steward
			TARGET = scope:replaced_steward
		}
		assign_new_councillor = { # Spymaster
			TYPE = councillor_spymaster	
			TARGET = scope:replaced_spymaster
		}
	}
}